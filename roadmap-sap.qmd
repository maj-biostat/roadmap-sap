---
title: Statistical Analysis Plan
subtitle: |
    ROADMAP: RandOmised Arthroplasty infection worlDwide Multidomain Adaptive Platform trial - analysis plan
description: |
    Investigator initiated, Randomised Embedded Multifactorial Adaptive Platform (REMAP) trial, conducted across multiple hospitals in several regions of the world.
date: last-modified
date-format: "D MMMM YYYY"
author: 
  - name: Mark Jones
    id: mj
    email: mark.jones1@sydney.edu.au
  - name: James Totterdell
    id: jt
    email: james.totterdell@sydney.edu.au
version: 0.1
sponsor: University of Newcastle, NSW, Australia
protocol-number: Version 1.1  01AUG2024
registration: todo
hrec: todo
ci1: Professor Joshua Davis  
ci2: Professor Laurens Manning
editor: source
bibliography: etc/refs.bib
csl: etc/elsevier-harvard.csl
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
```

```{r, echo = F}
#| echo: false

# uml digs
library(nomnoml)
library(ggplot2)
suppressPackageStartupMessages(library(data.table))
library(tibble)
library(gt)
library(kableExtra)
suppressPackageStartupMessages(library(qs))
library(git2r)
```

{{< pagebreak >}}

::: summary
|     |        |
|:----|:------------|
|Study title:  |  ROADMAP: RandOmised Arthroplasty infection worlDwide Multidomain Adaptive Platform trial |
|Intervention: |  Surgery type, backbone antibiotic duration, extended prophylaxis, antibiotic type |   
|Study design:  |   Randomised Embedded Multifactorial Adaptive Platform trial | 
|Sponsor:  |    University of Newcastle, NSW, Australia | 
Protocol: |  Version 1.1  01AUG2024 |
|Registration:  |    todo | 
|HREC:  |   todo | 
|Study date of first consent:  |   todo | 
|Principal coordinating investigators:  |   Professor Joshua Davis  and Professor Laurens Manning | 
:::

<!-- 
Note that the above relies on the pandoc extension implemented in the lua file 
in the etc directory. It additionally relies on the presence of a custom style
in word called study summary. It will currently only work for word (because I
cannot be bothered to implement it in anything else at the moment).
-->


{{< pagebreak >}}

# Version history {.unlisted .unnumbered}

| Version    |   Date     | Change    |   Reason     |
|:----|:------------|:----|:------------|
| 0.1 | 09/2024 | First version | N/A |
| 0.2 | 12/2024 | Review 1 | Edits based on initial comments from TS and JT |


{{< pagebreak >}}

# Repository status {.unlisted .unnumbered}

\footnotesize
```{r}
#| echo: false
repo <- repository(path = ".")
summary(repo)
```
\normalsize

{{< pagebreak >}}

# Document update procedures

The SAP is an operational document that will be updated, as necessary, prior to each analysis.

For each analysis, the current SAP must be a dedicated release within the repository and referenced within the analysis report.


# Introduction

ROADMAP is a platform study for pragmatically evaluating the efficacy of multi-modal interventions used in the treatment of prosthetic joint infection (PJI).
The primary application is to inform clinical decision making at the point of care.
It is an international study run in Australia, New Zealand, Canada and the UK with partners from the academic sector.
It is also designed to be a perpetual study and uses a single Master Protocol to dictate procedures and conduct.

Each set of interventions (domain) are detailed within separate Domain Specific Appendicies (DSA) to the Master Protocol. 
Conclusions and reports will be produced separately with some participant outcomes being used in multiple reports, thereby potentially contributing to the inference associated with several interventions.
All DSAs will be evalauated under a single model specification and a single analysis plan (this document) is used cover all DSAs.

## Background motivating research question(s) {#sec-background}

ROADMAP is motivated by several high-level questions relating to the management of prosthetic joint infections, specifically:

1. For patients with *late-acute*^[Page 15 of ROADMAP Core Protocol_V1.1_01Aug2024_clean.pdf says "For early post- operative infections". Think this would be clearer to refer to cohort.] post-operative infections, is it better to keep the existing prosthetic joint and clean the infection or to replace the joint entirely?
2. What is the most effective duration of backbone antibiotics for patients receiving *one-stage revision*^[Page 15 of ROADMAP Core Protocol_V1.1_01Aug2024_clean.pdf says "What is the most effective duration of antibiotics after surgery?". Think this would be clearer to refer specifically to the type of surgery.] surgery?
3. Is it better to include rifampicin (or not) in the backbone antibiotic treatment regimen?

Each of these will be evaluated in relation to the primary outcome, which is a composite outcome defined at 12-month post platform entry.
Specifically, the co-occurrence of the following states (paraphrased from the protocol, which has a more complete definitions):

1. Alive
2. No evidence of infection
3. No ongoing use of antibiotics for the index joint 
4. Destination prosthesis in place 

For the purposes here, the absence of any of the above elements is considered to be a treatment failure.

::: {.callout-note}
Justification required for the above.
:::


## Objectives and endpoints

The primary goal of ROADMAP trial is to examine the effect of a range of interventions in platform-eligible patients with PJI on treatment success as defined earlier, see @sec-background.
@tbl-obj provides a high-level summary of each of the domain objectives with further detail in the protocol.

```{r}
#| echo: FALSE
#| label: tbl-obj
#| tbl-pos: H
#| tbl-cap: "ROADMAP domain-level analytic objectives"

d_tbl <- tribble(
  ~ domain, ~ objective, ~ endpoint, 
  "Surgical" , "Determine whether revision (understood as a sample-weighted average of the effects of one and two-stage revision) is more effective than debridement in curing prosthetic joint infections in late-silo units."  , "Treatment success at 12 months (alive, no evidence of infection, no antibiotics for PJI, destination prothesis in place)." ,
"Antibiotic duration" , "Determine whether 6 weeks of backbone antibiotic is non-inferior to 12 weeks in curing prosthetic joint infections in units receiving one-stage revision." , "Treatment success at 12 months." ,
"Extended prophylaxis" , "Determine whether 12 weeks of extended prophylaxis is more effective than none in curing prosthetic joint infections in units receiving two-stage revision.", "Treatment success at 12 months." ,
"Antibiotic choice" , "Determine whether the addition of rifampicin is more effective than none in curing prosthetic joint infections in units where one or more of the causative organisms is a Gram-positive type of interest (or infection is culture negative)." , "Treatment success at 12 months." 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(15),
    objective ~ pct(50),
    endpoint ~ pct(35)
  ) |>
  cols_label(
    domain = "Domain",
    objective = "Objective",
    endpoint = "Endpoint"
  ) |>
  tab_options(table.font.size = "80%")

gt_tbl
```


## Estimands

::: {.callout-note}
## Discussion required

The estimands are introduced in generality in the core protocol and made specific in the DSA.
I feel like the estimands are not currently providing much value because there isn't enough detail and they do not really seem to consider the ICE implications to the existence or interpretation of the outcome.
This could lead to some criticism, however, given that the vast majority of the analyses are under treatment-policy, this vagueness might not really matter.
One way might be to minimising any duplication across documents.
For example, we might remove the estimands in the core protocol, which are not really adding anything, and just retain the DSA definitions.
The rationale for this stems from the fact that the core protocol specifications do not relate to any single intervention and therefore do not really address the issues that estimands are intended to address, i.e. they do not provide clarity on what effects we are targeting nor on the ICEs as noted above.
As a side note, in my opinion, I feel that if the overall objective is on assessing risk, then that should be what we are aiming to infer analytically rather than odds ratios.
:::

The estimands are provided in the core protocol and the domain specific appendicies (identifiers adopted below correspond to the DSA definitions).

Estimands emphasise what is being estimated rather than how the estimation is undertaken.
In the following sections, we provide further detail to the specifications provided in the protocol and DSAs with a focus on the treatment regimen, the population summaries and the intercurrent events.

Where the treatment policy strategy is used, any ICEs are effectively ignored and/or considered part of the treatment protocol.
Where other methods of handling ICEs are used, it is important to recognise that treatment-specific ICEs may occur in isolation for a given unit or in conjunction with ICEs applicable to treatments from other domains.
For example, a patient may switch from DAIR to two-stage revision due to having a loose joint but also discontinue extended prophylaxis due to adverse reaction.
In such cases, the ICEs are still handled by the applicable strategy for the estimand under consideration.
This implies, for the above example, that for the surgical domain comparison, we would likely consider the implication of the cross-over alone and not contemplate the impact that discontinuing may have.
Similarly, when considering the extended prophylaxis comparison, we would likely only refer to the ICE associated with discontinuation and not the ICE relating to the loose joint.

### Primary estimand {#sec-html-tables}

A primary estimand is defined in the core protocol which is intended to cover the treatment-level comparisons for all the domains.
The DSAs subsequently introduce a domain-specific primary estimand (along with secondary estimands) by adding some detail on the treatment arm comparisons that are to be undertaken for the domain.
For all domains, the primary estimand adopts a treatment policy strategy to ICEs, which is equivalent to an intention to treat (ITT) approach.
In other words, all ICEs are effectively considered to be part of the treatment regimen of interest and therefore receive no further consideration, @Mallinckrodt2020.
However, it is worth noting that the primary outcome definition actually implies a composite estimand strategy for (what would be) ICEs relating to both death and the replacement of desination prothesis^[While death (occurring prior, during or after the occurrence of the intervention) may ordinarily be considered an intercurrent event in this clinical setting, it has been accounted for by its inclusion in the primary outcome definition, i.e. we implicitly adopt a composite strategy for death. Similarly, secondary or rescue surgery leading to the removal of a prosthetic is accounted for by its inclusion in the primary outcome definition and again implies the composite strategy. These subtleties have to be kept in mind when interpreting and generalising the results.].

The following extends and aims to aid interpretation.

#### Estimand B.1 (surgical intervention)

::: {.callout-note}
## Update required

On (Page 19, ROADMAP Surgical Late Acute DSA. V1.1_01Aug2024.pdf) there is a note in parentheses that states "this will be estimated within hip versus knee strata". If the intention is to have joint specific focus on the surgical treatment effects then this should be explicitly stated as part of the estimand objective.
At the stats meeting dated 9/12/2024, we decided to apply stopping rules to the aggregated hip and knee groups rather than adapting the trial based on joint specific effect. However, both overall and joint specific effects are to be reported (see later). This is not yet reflected in a released protocol.

:::




<!-- In all cases, interest is in the main effects. -->

**High-level lay overview:**

The estimand considers the effect of removing the infected joint (irrespective of whether knee or hip) versus cleaning and leaving the joint in place on the outcome of treatment success status at 12 months, specifically within the cohort of patients with late-acute infection.

**ICEs and treatment regimen:**

::: {.callout-note}
## Discussion required
Other ICEs are possibly relevant but not yet considered.
The following are speculative possibilities.
First, withdrawal based on clinician opinion based on what is in the patient's best interest with regards to their involvement in roadmap. However, even if a patient is withdrawn by request of the clinician, it may be acceptable to continue to collect data on such a patient, in which case the treatment policy would still be relevant.
Second, deviations from assigned treatment in terms of variations in procedures per the protocol definitions but not leading to switching would also constitute an ICE that could impact the interpretation of the treatment effects. An example could be secondary surgery that does not lead to replacement of prosthetic, i.e. not handled via the composite strategy. Third, deviations from any protocol timings such as a requirement to have a surgical procedure within a given time window from randomisation.
Fourth, it should be considered whether switchover should be interpreted as a failure rather than an ICE.
Currently, any additional unspecified ICE would also be handled via the treatment policy strategy
:::

The protocol definitions for the surgical interventions are given in the DSA for the Surgical strategy domain, which is specific to the cohort of patients with late-acute infection.
These definitions provide detail for all the interventions under consideration.
For example, at a minimum, debridement and implant retention (DAIR) must include an open approach, exchange of modular components, removal of the synovial lining of the joint and irrigation etc.

The randomised treatment arms comprise DAIR and revision with the clinician permitted to self-select the type of revision (one or two-stage) to be used when a patient is assigned to the revision group.
The treatment regimen being evaluated is expanded upon below.

Likely intercurrent events for the surgical domain and the approaches used to handle them are summarised in @tbl-ice-b1.

The treatment regimen under evaluation is the randomised and revealed surgical treatment in addition to a specific combination of randomised treatments and non-randomised treatments associated with other domains, and, with any occurrence of specified or unspecified ICE(s).
The comparison of groups allow for lack of adherence, adding or switching, changes in background medication.
The estimand is therefore not associated with a specific single treatment protocol, but rather reflects a mix of procedures that commonly occur when undertaking DAIR or revision.

{{< pagebreak >}}


```{r}
#| echo: FALSE
#| label: tbl-ice-b1
#| tbl-pos: H
#| tbl-cap: "Surgery domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "B.1(i1)" , "DAIR"  , "If prosthesis is found to be loose when the joint is opened, the surgeon would routinely override allocation and do a revision. Expected in x% of patients." , "Switchover" , "Treatment policy" ,
"B.1(i2)" , "Revision"  , "If the patient becomes clinically unstable prior to or during the operation, the surgeon may abandon the attempt at revision and revert to a DAIR. Expected in x% of patients." , "Switchover" , "Treatment policy" ,
"B.1(i3)" , "Revision"  , "If one or more components of the prosthesis are too difficult to remove, the surgeon may abandon the attempt at revision and revert to a DAIR. This is more likely with a non-cemented hip than with a cemented hip or a knee. Expected in x% of patients." , "Switchover" , "Treatment policy"  
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Treatment",
    ice = "ICE",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "70%") |> 
  tab_footnote(
    footnote = md("Switchover will not generally result in the outcome variable being missing (assuming the patient followup continues to completion) but does affect the interpretation of the result due to dilution of the treatment effect. For an (admittedly contrived) example, in a two-arm trial, if the majority of units assigned to the first treatment switched over to the second treatment and none of the units assigned to the second treatment switched then an ITT/treatment policy approach would be comparing groups of units that effectively received the same treatment."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )

gt_tbl
```




**Population summary:**

::: {.callout-note}
## Discussion/update required
I feel like risk differences are maybe preferable as they are more directly interpretable than odds ratios, albeit a bit more work to the analyst.
However, the implication is that we need to be explicit about which population we are marginalising over. 
Typically, this would be the patients in the trial but given our comparisons are very specific, the levels which we use in the g-computation are also specific for some terms.
The random effects will probably be taken to be zeros and so our inference will be interpretable for the 'typical' site (or whatever the random effect pertains to).
:::

The population-level summary measure is the conditional log odds ratio for revision comprising both one-stage and two-stage procedures relative to DAIR.

**Data useful for estimand:**

It is important that units continue to be followed up after the occurrence of an ICE to obtain detail on the final status of the primary outcome.

**Main estimator:**

A single Bayesian multivariable logistic regression model is used to characterise unit responses for the primary outcome across all domains, see @sec-primary-analysis.

Given the desire to accommodate clinician-choice with regards to revision type and the dependency between specific revision types and entry into the antibiotic duration and extended prophylaxis domain, the population-level summary is constructed as a weighted conditional log odds ratio where the weights adopted are to be informed by the sample distribution for the surgical revision type under assignment to revision.

**Missing data:**

Missing data might arise on account of limitations in identifying clinical records, formal requests from patients to completely withdraw from the study (including use of data), loss to follow up due to relocation, human error etc.
Additionally, components of the composite outcome may not be available in the clinical records (e.g. ongoing use of antibiotics for the specific reason of managing prosthetic infection might not be adequately recorded).
Missingness will be assumed to be low and at random across all variables and variable components such that imputation could, in principle, be undertaking by conditioning on observed variates.
Under these assumptions, that is that the missingness is not simultaneously dependent on the outcome and exposure, multiple imputation is not technically required to obtain unbiased estimates of the treatment effect and a complete-case (likelihood-based) analysis will yield unbiased estimates of the treatment effects.
As such, multiple imputation will not be adopted for the primary outcome variable.
Where it occurs, missingness in covariates will be addressed by deduction (where possible) or fixed imputation scheme (if reasonable) the details of which being disclosed in the reporting.

**Sensitivity:**

Tipping point sensitivity analysis and multiple imputation schemes may be considered and implemented at the discretion of the analyst, the details of which being disclosed in the reporting.

#### Estimand D.1 (antibiotic duration intervention)

**High-level lay overview:**

The estimand considers the effect of the backbone antibiotic duration on treatment success at 12 months, specifically whether 6 weeks (a short duration) of backbone antibiotic is non-inferior to 12 weeks (a long duration) in patients receiving one-stage revision.

::: {.callout-note}
## Discussion/update required
Get confirmation that receipt of one-stage revision is the correct population definition.
:::

**ICEs and treatment regimen:**

The protocol definitions of the interventions are provided in the DSA for the antibiotic duration domain following single stage revision.

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-d1 where the treatment policy ICE strategy aims to establish the effect of treatment assignment.

```{r}
#| echo: FALSE
#| label: tbl-ice-d1
#| tbl-pos: H
#| tbl-cap: "Antibiotic duration domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "D.1(i1)" , "6 wk"  , "If patient has slow improvement, recrudescence of infection or need to return to theatre then clinicians may choose to prolong antibiotic therapy." , "Extension to therapy" , "Treatment policy" ,
"D.1(i2)" , "12 wk"  , "Adverse effects of antibiotics or patient discharge/relocation may lead to early termination of therapy." , "Discontinuation" , "Treatment policy" 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Assigned",
    ice = "Endpoint",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "70%")  |> 
  tab_footnote(
    footnote = md("Extended therapy in the 6 week group would make the responses more similar to the 12 week group leading to increase likelihood of non-inferiority decision, i.e. conclusions may anti-conservative."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )  |> 
  tab_footnote(
    footnote = md("Discontinuation in the 12 week group would make the responses more similar to the 6 week group."),
    locations = cells_body(
      columns = class,
      rows = 2
    )
  )

gt_tbl
```


The treatment regimen under evaluation is the randomised and revealed antibiotic duration treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.


::: {.callout-note}
The more I review this, the more I wonder if it really is an accurate representation of the regimen of interest and whether our single model (highly conditional) perspective is actually what is required.
This is despite the fact that I believe that the conditional perspective is the only one that really makes sense here in terms of being reasonably well defined and that the intrinsically vague pragmatic perspective might not be the right way to approach this research problem.
:::


**Population summary:**

The population-level summary measure is the conditional log-odds-ratio for 6 weeks backbone antibiotic relative to 12 weeks.

Other sections are as per the considerations and definitions for B.1.



#### Estimand E.1 (extended prophylaxis intervention)

**High-level lay overview:**

The estimand considers the effect of the extended prophylaxis on treatment success at 12 months, specifically whether 12 weeks of extended prophylaxis is more effective than none following the second stage of the revision procedure in patients receiving two-stage revision.

**ICEs and treatment regimen:**

The protocol definitions of the interventions are provided in the DSA for the Antibiotic duration domain (extended prophylaxis) following a two-stage revision.

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-e1 where the treatment policy ICE strategy aims to establish the effect of treatment assignment.

```{r}
#| echo: FALSE
#| label: tbl-ice-e1
#| tbl-pos: H
#| tbl-cap: "Extended prophylaxis domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "E.1(i1)" , "None"  , "If the patient has slow improvement, recrudescence of infection or need to return to theatre then clinicians may choose to prolong extended prophylaxis therapy." , "Extension to therapy" , "Treatment policy" ,
"E.1(i2)" , "None"  , "If the patient shows late positive culture, they may become ineligible post-reveal and would liekly require an additional 6-12 weeks of backbone antibiotic." , "Extension to therapy" , "Treatment policy" ,
"E.1(i3)" , "12 wk"  , "Adverse effects of antibiotics or patient discharge/relocation may lead to early termination of therapy." , "Discontinuation" , "Treatment policy" 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Assigned",
    ice = "Endpoint",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "70%")  |> 
  tab_footnote(
    footnote = md("Extended therapy in the no extended prophylaxis group would make the group more similar to the 12 week group leading to increase likelihood of non-inferiority decision, i.e. conclusions may anti-conservative."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )  |> 
  tab_footnote(
    footnote = md("Discontinuation in the 12 week group would make the responses more similar to the no extended prophylaxis group."),
    locations = cells_body(
      columns = class,
      rows = 3
    )
  )

gt_tbl
```


::: {.callout-note}
todo - Get more detail on E.1(i2) and check my interpretation is correct.
:::


The treatment regimen under evaluation is the randomised and revealed extended prophylaxis treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.


**Population summary:**

The population-level summary measure is the conditional log-odds-ratio for 12 weeks extended prophylaxis relative to none.

Other sections are as per the considerations and definitions for B.1.


#### Estimand C.1 (antibiotic choice intervention)

**High-level lay overview:**

The estimand considers the effect of the antibiotic choice on treatment success at 12 months, specifically whether the use of rifampicin is more effective than none for domain eligible units.

**ICEs and treatment regimen:**

The protocol definitions of the interventions are provided in the DSA for the Antibiotic choice domain.

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-c1 where the treatment policy ICE strategy aims to establish the effect of initially randomised treatment.

```{r}
#| echo: FALSE
#| label: tbl-ice-c1
#| tbl-pos: H
#| tbl-cap: "Choice domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "C.1(i1)" , "None"  , "If the patient has slow improvement (e.g. 1-4 weeks post operatively), clinicians may add rifampicin despite assignment." , "Switchover" , "Treatment policy" ,
"C.1(i2)" , "Rifampicin"  , "If the site pharmacy runs out of or does not have any rifampicin in stock, this may lead to early termination or non-receipt of therapy." , "Discontinuation or non-receipt" , "Treatment policy" ,
"C.1(i3)" , "Rifampicin"  , "Adverse effects of rifampicin (intractable nausea, severe hepatitis) may lead to early termination of therapy." , "Discontinuation" , "Treatment policy"  
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Assigned",
    ice = "Endpoint",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "70%") |> 
  tab_footnote(
    footnote = md("Both discontinuation/non-receipt of rifampicin or addition of rifampicin to the the control group make groups more similar than they otherwise would be."),
    locations = cells_body(
      columns = class,
      rows = c(2,3)
    )
  )

gt_tbl
```

::: {.callout-note}
todo - Clarify C.1(i1) - would this still constitute switchover after the delayed start (or rescue)?

As with other domains, patient discharge/relocation is probably relevant as another ICE.
:::

The treatment regimen under evaluation is the randomised and revealed antibiotic choice treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.

**Population summary:**

The population-level summary measure is the conditional log-odds-ratio for rifampicin relative to none.

Other sections are as per the considerations and definitions for B.1.


### Supportive estimands

Supportive estimands are provided to address the needs of other stakeholders giving alternative perspectives and interpretations of intervention effects.

Given the number of estimands defined in the DSAs, only those where ICEs are not handled under the treatment policy strategy are discussed.

#### Estimand B.2 (surgical intervention)

**High-level lay overview:**

Per the primary estimand for the surgical domain, this supportive estimand considers the effect of removing the infected joint versus cleaning and leaving the joint in place on treatment success at 12 months.
However, the treatment regimen under consideration is tightened to a sub-population that adhered to the assigned treatment.

::: {.callout-note}
The manner in which the estimand is currently written, aligns with a per-protocol analysis whereby only those patients that were adherent to their assigned (observed) treatment are retained in the analysis.
This doesn't consider whether those patients would also be adherent in their counterfactual treatment.
The problem with this is that it violates the randomisation - the groups might be unbalanced on either known or unknown (or both) confounders.
The traditional per-protocol effect is well known to produce biased estimates for treatment effects.
What I believe is of interest is the effect of the surgical intervention in those that would have adhered to all arms.
Given that the ICEs for the surgical domain negate the possibility of forcing the assignment on the patient, principal strata seems like the most well aligned approach.
To discuss further.
:::

**ICEs and treatment regimen:**

ICEs are per the primary estimand for the surgical domain.

::: {.callout-note}
The DSA currently states that principle stratum strategy is to be used as the single mechanism for handling ICEs.
Obviously, this is a placeholder as it was a fairly arbitrary inclusion.
For the surgical domain currently specified ICEs are switchover to revision for DAIR where the joint is loose and similarly for revision when the it is not possible to remove the existing implant.
Additionally, revision might be abandoned if the patient becomes unstable during the operation.
To handle these via desired strategy we first conceptualise strata.
The subset associated with the compliers (however that is defined here) would be the one for which we would estimate the effect of DAIR vs revision.
:::

<!-- Note to self - see earlier correspondence b/w TS and MJ in the comments at the end of this file. -->

**Population summary:**

todo

**Data useful for estimand:**

It is important that units continue to be followed up after the occurrence of an ICE to obtain detail on the final status of the primary outcome.

Record which of the patients, assigned to revision, had loose joints such that had they been assigned to DAIR, then switchover would likely have occurred.

Record which of the patients, assigned to DAIR, had indications of prosthesis that would likely be difficult to remove, such that had they been assigned to revision, then switchover would likely have occurred.

Record if the patient became unstable or neared instability at any point during the procedure for both DAIR and revision.

#### Estimand D.2 (antibiotic duration)

**High-level lay overview:**

This supportive estimand considers the effect of the duration of backbone antibiotics on treatment success at 12 months, specifically whether 6 weeks (a short duration) of backbone antibiotic is non-inferior to 12 weeks (a long duration) in patients receiving one-stage revision.
However, the treatment regimen under consideration is tightened to a sub-population that adhered to the assigned treatment.

todo - finalise approach

#### Estimand E.2 (extended prohylaxis)

todo - pp finalise approach

#### Estimand C.2 (antibiotic choice)

todo - pp finalise approach

## Study design

ROADMAP is an investigator-initiated, phase IV (open label), multicentre, pragmatic, randomised embedded multifactorial adaptive platform (REMAP) formulated to investigate the effectiveness of multiple study interventions simultaneously in cohorts of patients with confirmed or likely prosthetic joint infection in a large joint (hip, knee) with no age restriction.
ROADMAP also includes the development of a registry, although that will not be discussed here.

Initial treatment modality groups (domains) examine surgery type, antibiotic duration, extended prophylaxis and antibiotic choice.
New interventions are permitted to enter into existing domains and new domains are also permitted, both subject to steering committee and ethics review.

ROADMAP will be conducted sequentially (cohorts of 500 patients) with decision rules evaluated on parameter estimates of interest, driving domain-level stopping rules and platform conclusions.
Early stopping is permitted under pre-specified conditions, specifically for superiority, non-inferiority and futility as applicable to the given domain.

Bayesian methods were selected for their inherent flexibility, ease of both uncertainty quantification and their capacity for incorparating adaptive elements, regularisation of parameter estimates and simplicity in interpretation.

### Randomisation

Units will be randomised (under fixed complete randomisation, i.e. non-adaptive and without restriction through blocking or stratification or other constraints) to one arm within each domain for which they are eligible [@Rosenberger2016].
This method was selected for its operational simplicity.
As entry into the duration domains are dependent on the status of the surgical intervention, some subtleties arise.
For example, only units in receipt of one-stage revision can be revealed to randomised assignment for antibiotic duration which also prevents entry into extended prophylaxis.
Similarly, only units in receipt of two-stage revision can be revealed to randomised assignment for extended prophylaxis. 
A practical way to operationalise this is to simply randomise each unit to all available domains and then reveal the allocation as necessary and that is the approach used here.
Thus, the reveal process actuates the randomised treatment and until this occurs, the unit is effectively not part of the randomised sample from the analysis perspective, i.e. they would not contribute to treatment effect estimation.

As a concrete example, a unit within any of the early, late or chronic silo would be allocated interventions for all domains.
However, for early silo units, the surgical interventions are irrelevant and so never revealed, the antibiotic duration interventions would only be revealed if one-stage was received, the extended prophylaxis would only be revealed if two-stage was received and so on.

### Sample size

The initial trial funding and infrastructure has sufficient resources to enrol up to 2,500 participants into the platform.
Thus, the sample size is constrained by the current resources and the desired trial structure.
However, the study is intended to be perpetual and will seek funding to ensure recruitment beyond the initial sample size, if necessary.
The sample size has implications on the amount of uncertainty that can be resolved under assumptions about the cohort population, study design and assumed magnitude of effects and this will be discussed later.

### Data management

An overview is provided in the Master Protocol.
However, we note that the data storage approach will be decomposed into redcap components and (out-sourced proprietary) platform components developed by Spiral Software^[https://spiral.co.nz/], the latter also being responsible for the implementation of the randomisation processes.

::: {.callout-note}
todo - double check and write up on how this functionality is being decomposed. 
What are the redcap parts and what belongs to spiral?
:::

# Statistical methods

## Analysis sets

### Intention to treat

The intent to treat (ITT) principle covers what units to include and what data to include on each unit.
A strict interpretation of ITT demands collection and analysis of all randomised units, but, in practice, minor deviations from this ideal are routinely accepted.

Estimands B.1 through C1 align with the ITT perspective via their use of the treatment policy strategy.
The analysis population used for these will include all units that were randomised and revealed to at least one of the domain-level interventions and have passed the primary endpoint of 12-months with their primary endpoint status known or known to be missing.

Per the treatment policy strategy, all randomised patients will be included and analysed according to the regimen to which they were initially allocated irrespective of any deviations from this regimen or any other protocol deviations.

Participants that have reached follow up, but for whom information has not yet been gathered will be treated as missing until the data has been entered.
Participants who have been randomised, but have not yet reached the primary endpoint, will be excluded.

### Per-protocol

::: {.callout-note}
Per-protocol analyses traditionally exclude those patients that deviate from the protocol and conduct the primary analysis with this subset.
The results from such analyses will only be valid where deviations from the protocol are non-informative.
Consider (1) exclusions can imbalance treatment groups on known or unknown confounders and prognostic factors (2) that noncompliance may relate to a specific intervention or disease severity producing differential dropout across arms.
:::

The minimal requirements for determining that patients fit the protocol criteria are provided in @tbl-pp1.
The protocol criteria are solely in regards to the manner in which the interventions were delivered.

::: {.callout-note}
todo - For the 6wk and 12wk antibiotic duration assignment, is there a reqt for no ab after 16 wks? For the extended prophylaxis, is there a reqt for no ab after 90 days? For the Rifampicin, is there any requirement for the interval between the doses?
:::



```{r}
#| echo: FALSE
#| label: tbl-pp1
#| tbl-pos: H
#| tbl-cap: "Minimal requirements for per protocol population"

d_tbl <- tribble(
  ~ domain, ~ assignment, ~ per_protocol_reqt, 
  "Surgical", "DAIR", "Part or all of the index prosthesis was retained, and an open arthrotomy was performed, including synovectomy, lavage and exchange of modular components (if present), between platform entry and day 90",
  "", "Revision", "The index prosthesis was completely removed, with no residual prosthetic components, and either a new prosthesis or a temporary spacer was placed at the first stage operation, between platform entry and day 90",
  "Antibiotic duration", "6 weeks", "At least 5 weeks but no more than 7 weeks of antibiotic therapy has been completed between the date of the one-stage revision and 16 weeks later",
  "", "12 weeks", "At least 11 weeks and no more than 13 weeks of antibiotic therapy has been completed between the date of the one-stage revision and 16 weeks later",
  
  "Extended prophylaxis", "None", "Less than 14 days of antibiotics were received for the index joint between the reimplantation operation and platform day 90",
  
  "", "12 weeks", "10-14 weeks of antibiotics were received for the index joint between the reimplantation operation and platform day 90",
  
  "Antibiotic choice", "Rifampicin", "At least 1 dose of rifampicin was received on each of at least 7 days between confirmation of domain eligibility and the end of platform day 28.",
  "", "None", "Less than 3 doses of rifampicin were received (i.e. zero, one or two) between confirmation of domain eligibility and the end of platform day 90.",
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(20),
    assignment ~ pct(20),
    per_protocol_reqt ~ pct(60)
  ) |>
  cols_label(
    domain = "Domain",
    assignment = "Assignment",
    per_protocol_reqt = "Requirement"
  ) |> 
   tab_footnote(
    footnote = md("Antibiotics [if the patient is still on them] are ceased within 24 hours of confirmation of allocation reveal – which will be 4-10 days post the reimplantation stage"),
    locations = cells_body(
      columns = domain,
      rows = 5
    )
  ) |>
  tab_options(table.font.size = "80%")

gt_tbl
```

## Subgroups {#sec-subgroups}

::: {.callout-note}
todo - clarify how duration of symptoms is intended to be categorised for surgical domain.
:::

Stratification of effects to subgroup populations enable effect heterogeneity to be explored, but come at the increased risk of instability, bias and false positives.
Subgroup populations have been identified in the various appendices but are duplicated here in @tbl-subgrp-1 in summary form for convenience.

```{r}
#| echo: FALSE
#| label: tbl-subgrp-1
#| tbl-pos: H
#| tbl-cap: "Subgroup populations"

d_tbl <- tribble(
  ~ domain, ~ subgroup, 
  "Surgical", "Site of infection by joint (hip/knee)",
  "", "Duration of symptoms at domain entry in days", 
  "", "At least one causative organism is S. aureus versus not", 
  "", "Serum C-reactive protein (CRP) at platform entry <100 versus >=100", 
  "", "Time from implantation of the index prosthesis to domain entry in days", 
  "", "One stage versus two stage revision (in those who are allocated to revision surgery)", 
  "Antibiotic duration", "Silo membership (early, late-acute or chronic)",
  "", "At least one causative organism is known at the time of domain eligibility assessment to be Staphylococcus aureus versus not",
  "", "Revision procedure has all elements of an ‘ideal’ procedure vs.  not",
  "Extended prophylaxis", "Silo membership", 
  "", "At least one causative organism is known at the time of domain eligibility assessment to be Staphylococcus aureus versus none", 
  "", "Duration between first-stage and reimplantation procedure", 
  "", "Duration of antibiotic treatment between first-stage and reimplantation procedure", 
  
  "Antibiotic choice", "Type of surgery (DAIR, one-stage, two-stage)", 
  "", "At least one causative organism is a Staphylococcus (any species) versus none"
  )


gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(30),
    subgroup ~ pct(70)
  ) |>
  cols_label(
    domain = "Domain",
    subgroup = "Subgroup"
  ) |>
  tab_options(table.font.size = "80%")

gt_tbl

# kableExtra::kbl(
#   d_tbl, format = "latex", align = c("l", "l", "l", "l"), escape = FALSE,
#   col.names = c("Domain", "Subgroup population")) |>
#   kable_paper("hover", full_width = F) |>
#   column_spec(2, width = "13cm") |>
#   kable_styling(latex_options = "scale_down") 
#  see above comment - do not use hold_position, use tbl-pos instead
#   kable_styling(latex_options = "hold_position")
```



## Description


A CONSORT diagram will will be provided to detail patient progression showing:

+ participants screened
+ participants eligible (giving reasons for ineligibility)
+ participants consented
+ participants entering into randomised treatment (revealed) by domain and intervention
+ participants withdrawing from study
+ participants reaching 12-month follow up

Recruitment numbers will be reported by region and site and intervention availability by domain will be presented, again by site.

Protocol deviations and intercurrent events will be summarised by domain and intervention.
Baseline demographics will be provided by domain and intervention.

## Sequential analyses

Interim analyses will be run over the life of the trial to evaluate pre-specified decision criteria.
Analyses will start once 500 participants have reached 12 months follow up and every 4 months thereafter.

::: {.callout-note}
todo - revisit this timing (I am aware it slight contradicts the earlier statement)
I think it is probably more operationally practical to run interims on a regular timing rather than for fixed sample size.
:::

The analysis will focus solely on the primary outcome and will follow the approach detailed in @sec-primary-analysis.
Subgroup analyses may be run at each interim analysis, conditional on futility rules being triggered. 

With the exception of the clinicial team and patients involved in delivery and receipt of the interventions, only the analytical and data groups responsible for providing analysis results to the DSMC will be privy to individual-level treatment group assignments.

## Analysis approach

Analyses will be conducted within a Bayesian framework with a focus on the estimation of estimands as detailed earlier.
Parameter estimates will be computed via Markov chain Monte Carlo (MCMC) using Hamiltonian Monte Carlo (HMC).
Posterior summaries will be reported as posterior means and medians with 95% credible intervals.
Convergence will be assessed visually and with reference to appropriate statistics. 
Model fit will be considered with reference to posterior predictive checks. 

## Primary analysis {#sec-primary-analysis}

The primary analysis model for ROADMAP will adjust for silo, joint, preference for revision type, region, site, time period of recruitment and baseline characteristics, adopting the following form:

<!-- see the latex physics manual for vector va, vb notation -->
<!-- in brief, for greek letters you need the * -->

$$
\begin{aligned}
Y &\sim \text{Bernoulli}(p) \\
\text{logit}(p) &= \mu + \lambda_s + \rho_j + \phi_q + \sum_{d \in \mathcal{D}} \va{x}_{d}^\prime \va*{\beta}_{d} + \tau_t + \psi_r + \zeta_{z(r)} + \va{w}^\prime \va*{\gamma}
\end{aligned}
$$

<!-- alternatively for transpose use \va{x}_{d}^\top -->

where $Y$ is a binary variable representing unit level treatment success with probability $p$ and the linear predictor terms are as follows:

+ $\mu$	reference level log-odds of a successful outcome
+ $\lambda_s$ shift attributable to membership in silo $s$
+	$\rho_j$ shift attributable site of infection $j$
+	$\phi_q$ shift attributable to preference for type of revision surgery $q$
+	$\va*{\beta}_{d}$ shift attributable to each vector of treatment effects (including non-participation effects) as indicated by the row vector $\va{x}^\prime$ for domain $d$ in the set of available domains $\mathcal{D}$ 
+	$\psi_r$ shift attributable to region $r$ 
+	$\zeta_{z(r)}$ shift attributable to site $z$ nested within region $r$
+	$\tau_t$ shift attributable to randomisation period $t$
+	$\va*{\gamma}$ shift attributable to baseline characteristics as indicated by the row vector $\va{w}$

Constraints, as necessary, will be imposed for identifiability and disclosed in the reporting.

In order to estimate the treatment effects of interest we use g-computation as described in @sec-statistical-quantities.
Parameters estimates will be reported as point and interval summaries of the posterior.



### Priors

In general we will use weakly informative priors that aim to minnimally constrain the parameter estimates and are consistent with the belief that extreme treatment effects are unlikely.

The prior for $\mu$ will be set to

$$
\mu \sim \text{Logistic}(0, 1)
$$

which is centred on zero with 90% of its mass between $\pm 3$ on the log-odds scale and uniform on the probability scale.

The priors for all main effects will be set to 

$$
(\lambda_s, \rho_j, \phi_q, \va*{\beta}_d, \va*{\gamma}) \sim \text{Normal}(0, 2.5)
$$

which are centred on zero with 90% of its mass between $\pm 3.3$ on the log-odds scale.

::: {.callout-note}
todo - revisit baseline covariates with clinical group.
:::

The baseline covariates in the model include

+ age
+ sex
+ frailty score
+ ...


Noting that some domains may vary their active set of interventions over time, a first-order random walk may be used to model temporal variation in the background response.
The random walk prior has the following structure

$$
\begin{aligned}
\tau_1 &= 0 \\
\tau_i &= \text{Normal}(\tau_{i-1}, \sigma_\tau) \quad \forall \ i > 1 \\
\sigma_\tau &\sim \text{Exponential}(1)
\end{aligned}
$$

with indexes aligned with analyses and the $\tau_1$ term representing the most recent analysis^[In the event that analyses are not equidistant in time, adjustment may be made to the variance component in order to account for the variation in interval length.].

::: {.callout-note}
Question - Would it be preferable/more sensible to model on a finer granularity, i.e. monthly, quarterly etc?
:::

The prior for region will be set as per the main effects detailed above with the first region fixed to zero. 
Site priors will be nested within region and set as 

$$
\begin{aligned}
\zeta_{z(r)} &\sim \text{Normal}(0, \sigma_\zeta) \\
\sigma_\zeta &\sim \text{Exponential}(1)
\end{aligned}
$$


The primary analysis model will be assessed for adequacy. 

Additional models (either simpler or more complex) may be investigated as part of checks of sensitivity, stability, and model fit. 

If issues or concerns arise requiring modification to the analytical approach, for example, strong evidence of interactions across treatment domains, all variations will be documented and reported.

## Sensitivity analysis (applicable to primary)

todo 

## Subgroup analyses {#sec-subgroup-analyses}

Pre-specified subgroup analyses will be restricted to the primary estimand with additional post-hoc exploratory subgroup analyses being discretionary.
The general approach will be to use the complete data, incorporating first-order interactions via hierarchical modelling for each subgroup considered.

Analyses will be run at the time of final reporting for each domain, but also at interim analyses for the relevant domain-level subgroups, if a futility decision is triggered.
The latter analysis motivated by a prior belief of clinically relevant treatment effect heterogeneity and a desire to mitigate the possibility of terminating entry into a domain for subgroups when the possibility of a positive outcome remained.

To address subgroups, the primary analysis model is revised such that the parameters in the linear predictor are split for all relevant groups.
For example, for evaluation of silo-specific effects, the linear predictor would be revised to take the following form:

$$
\begin{aligned}
\mu_s + \rho_{j,s} + \phi_{q,s} + \sum_{d \in \mathcal{D}} \va{x}_{d}^\prime \va*{\beta}_{d} + \tau_t + \psi_r + \zeta_{z(r)} + \va{w}_s^\prime \va*{\gamma_{s}}
\end{aligned}
$$

leaving time and site effects unstratified (along with terms where identification is infeasible).
For each of the main effects, priors are converted to a hierarchical structure, for example for the surgical domain treatment effects:

$$
\begin{aligned}
(\va*{\beta}_{1,s}) &\sim \text{Normal}(\nu, \sigma_\nu) \\
\nu &\sim \text{Normal}(0, 2.5) \\
\sigma_\nu &\sim \text{Half-Normal}(0, 1)
\end{aligned}
$$

and with other main effects dealt with analogously.

<!-- minutes from 2024-09-09 -->

<!-- a.	Subgroups on joint: MJ: decision was to not look at heterogeneity in joint and make all decisions like assuming constant effects across joint in the interim analyses. At the interim analyses, do the subgroup analysis to look at heterogeneity by joint, and then have some sort of policy to put forward a case to the DSMC if needed as a way to see the differences in effects for various groups. LM: piano data doesn’t suggest there is a major difference in surgical outcomes between the two groups. Updated core protocol provides us the opportunity to leave one group open is there is inconsistency across the subgroups. MJ: operational perspective: make futility decision on surgery, look at sub-group specific effects of surgery and if one isn’t futile, there is the opportunity to continue randomising for those sub-groups. For any sub-groups in any of the domains (to avoid doing additional ethics amendment). Subgroups analysis only if the trigger is met.  MJ to consider -->

## Supportive (domain agnostic) analyses

The following sections detail analyses applying to all domains (hence *domain agnostic*) - interest is in treatment effects associated with all domain level interventions.

::: {.callout-note}
TODO - Query the competing risks, what is relevant/sensible to consider?

Should we revise the estimand definition such that we state clearly the issue of competing risk and that it is a part of the estimand that is being targeted (or change the estimand and estimation approach completely)?

:::

### Desirability of outcome ranking

A desirability of outcome ranking (DOOR) analysis involves unit level comparisons between all trial participants across the treatment arms.
Each patient receives a single rank to characterise their overall state at 12-months after platform entry with the current DOOR criteria provided in @tbl-sec-door.

```{r}
#| echo: FALSE
#| label: tbl-sec-door
#| tbl-pos: H
#| tbl-cap: "Ranking criteria for desirability of outcome for PJI"

d_tbl <- tribble(
  ~ Rank, ~ Alive, ~ JointFunc, ~ TrtSuccss , ~ Qol, 
  "1", "Yes", "Good", 
    "Yes", "Tiebreaker based on EQ5D5L",
  "2", "Yes", "Good", "No", "Tiebreaker based on EQ5D5L",
  "3", "Yes", "Poor", "Yes", "Tiebreaker based on EQ5D5L",
  "4", "Yes", "Poor", "No", "Tiebreaker based on EQ5D5L",
  "5", "No", "-", "-", "-"
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    Rank ~ pct(10),
    Alive ~ pct(10),
    JointFunc ~ pct(15),
    TrtSuccss ~ pct(15),
    Qol ~ pct(40)
  ) |>
  cols_label(
    Rank = "Rank",
    Alive = "Alive",
    JointFunc = "Joint Function",
    TrtSuccss = "Treatment Success",
    Qol = "Qol"
  ) |> 
   tab_footnote(
    footnote = md("*'Good'* joint function is based on thresholds related to patient reported success. A successful outcome at 12-months will be defined for knee PJI with an Oxford Knee Score (OKS) at 12 months of >36 or an improvement (delta) from baseline of >9 and for hip PJI as a Oxford Hip Score (OHS) of >38 or an improvement of >12 (35)."),
    locations = cells_body(
      columns = JointFunc,
      rows = 1
    ) 
    ) |> 
   tab_footnote(
    footnote = md("Treatment Success relates to primary outcome definition."),
    locations = cells_column_labels(columns = TrtSuccss) 
  ) |>
  tab_options(table.font.size = "80%")

gt_tbl
  
```

The DOOR analysis approach targets what has been called a *DOOR probability* but is more broadly referred to as a Probabilistic Index (PI), see @DeSchryver2018 and is equivalent to the Mann-Whitney-U statistic.
To calculate the PI we will enumerate all pairwise comparisons between all patients (win, loss, tie) and then the PI is given by

$$
\begin{aligned}
PI &= \frac{ (n_{win} + 0.5 n_{tie}) } { n_e n_c } 
\end{aligned}
$$

where $n_{win}$ and $n_{tie}$ are the number of instances where the experimental units do *better* than the control patients or have equivalent ranking respectively for all pairs and $n_e$ and $n_c$ are the number of patients in each of the two arms being compared.
We will produce confidence intervals via a bootstrap procedure or other methods.

We note that the PI refers to the probability that the outcome of a randomly selected subject in one group exceeds the outcome of another randomly selected subject in another group (plus half of the probability of a tied DOOR), see @Evans2015.
In principle, it targets:

$$
\begin{aligned}
\text{Pr}(Y_e > Y_c)
\end{aligned}
$$

where $Y_e$ is a random variable describing the outcome under an experimental treatment and $Y_c$ is a corresponding outcome under the control.

::: {.callout-note}
Care has to be taken when interpreting a PI.
First, the measure is NOT the probability that a patient will benefit from having the experimental treatment rather than control, which can generally only be obtained from a cross-over trial.
For example, a PI of 0.7 means that if you randomly select a patient from the experimental group and another from the control group, there is a 70% chance the experimental group patient will have a better outcome.
This is not the same as saying that 70% of patients will benefit from the experimental treatment.
For further cautions, limitations and critique on interpretation see @Senn2011.
:::

Separate DOOR analyses will be run on strata based on the assessment and ranking of the relevant outcomes at 12-months.
That is, in the DOOR analysis, we are comparing a subset of units over the interventions specific to a given domain.
Specifically:

+ For the surgical domain, the PI will be computed for only the units within the late-acute silo revealed to randomised treatment for this domain
+ For the antibiotic duration domain, the PI will be computed for only the units that received one-stage revision and revealed to randomised treatment for this domain
+ For the extended prophylaxis domain, the PI will be computed for only the units that received two-stage revision and revealed to randomised treatment for this domain
+ For the antibiotic choice domain, the PI will be computed for all units revealed to randomised treatment for this domain


::: {.callout-note}
A Bayesian approach to the MWU does exist, but has not been widely adopted to date and so we have opted for the above approach.
@Chechile2020 provides details on the Bayesian perspective.
:::

### Patient-reported joint function

The Oxford Hip Score (OHS) is a joint-specific, patient-reported outcome measure that has been designed to assess disability in patients undergoing joint replacement. 
The score is computed based on the responses to a 12-item survey.
Under the 2007 specification, responses range from 0 to 4 for each question and the total score has a maximum (best) value of 48 with 40-48 indicating satisfactory joint function and 3-5 being a suggested clinically important difference.

The OHS will be analysed using cumulative logistic regression based on the data obtained at 12-months after platform entry.
Letting $Y \in \{ 1, 2, \dots K \}$ denote the outcome (with $K = 49$ here, accounting for death as the lowest level) for unit $i$, the proportional odds model can be considered with reference to categorising some latent continuous variable $Y^*$.
Ordered cut-points, $c \in \mathbb{R}^{K-1}$ are defined such that $c_k < c_{k+1}$ with

$$
\begin{aligned}
\text{logit}(\text{Pr}(Y \le c)) = c_k - x^\top \beta
\end{aligned}
$$

<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \pi_{ik} = \text{Pr}(Y_i = k | \eta_i, c) = \begin{cases} -->
<!--     1 - \text{logit}^{-1}(\eta_i - c_1), & k=1\\ -->
<!--     \text{logit}^{-1}(\eta_i - c_{k-1}) - \text{logit}^{-1}(\eta_i - c_k), & 1 < k < K \\ -->
<!--     \text{logit}^{-1}(\eta_i - nc_{K-1}) , & k = K  -->
<!-- 		 \end{cases} -->
<!-- \end{aligned} -->
<!-- $$ -->

and where the linear predictor (generically stated in the above) would have terms and priors analogous to those used in the primary analysis.
The priors for the intercept terms would be based on a weakly informative dirichlet prior.

### Patient-reported quality of life (EQ5D5L)

The the EuroQOL 5 dimension 5 levels (EQ-5D-5L) instrument is a preference-based QoL instrument comprised of five dimensions: mobility, self-care, usual activities, pain/discomfort, and anxiety/depression.
Respondents are asked to choose the most appropriate option from five alternatives (none, slight, moderate, severe, or extreme problems). 
In addition, respondents are asked to indicate their present health state on a visual analogue scale (EQ VAS) ranging from the worst imaginable health state (“0”) to the best imaginable health state (“100”).

At this time, we assume that the QoL at 12-months after platform entry will be analysed by the health economics team and is therefore not specified here.

### Cost effectiveness

Similar to QoL at 12-months after platform entry we assume that this outcome will be analysed by the health economics team and is therefore not specified here.

### All-cause mortality to 12 months {#sec-all-cause-mortality}

We will use a logistic regression model to analyse all-cause mortality to 12-months after platform entry.
Specifically, if $Y$ is a binary indicatoring with $Y = 1$ indicating death from any cause at 12-months, we model:

$$
\begin{aligned}
Y &\sim \text{Bernoulli}(p) \\
\text{logit}(p) &= \eta = x^\top \beta
\end{aligned}
$$

where $\eta$ takes the same form as the primary analysis, see @sec-primary-analysis.

### Clinical cure to 12 months {#sec-clinical-cure}



The occurrence of clinical cure, defined in the master protocol as no clinical or microbiological evidence of infection, is subject to the competing risk of death.
We will use a logistic regression model to analyse clinical cure to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibility of death, this analysis actually yields a comparison of clinical cure (as defined within the context of the primary outcome) versus *either* clinical failure or death.
That is, if the patient dies then we will consider them a failure, irrespective of whether they were clinically cured or not at the time of death.

### No longer taking any antibiotics for the index joint to 12 months {#sec-prop-ab-free}

The ability to observe whether antibiotics are being used for the index joint is subject to  competing risks.

We will use a logistic regression model to analyse antibiotic use to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibility of competing risks, this analysis actually yields a comparison of no longer taking antibiotics (as defined within the context of the primary outcome) versus *either* taking antibiotics, joint removal, amputation or death.
That is, if the patient dies then we will consider them a failure, irrespective of whether they were taking antibiotics or not at the time of death.

### Destination prosthesis still in place to 12 months {#sec-joint-in-place}

The ability to observe whether the destination prosthesis is still in place is subject to the competing risk of death - we do not observe, counter to fact, whether those that die would or would not have had the destination prosthesis still in place.

We will use a logistic regression model to analyse destination prosthesis still in place to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibility of competing risks, this analysis actually yields a comparison of destination prosthesis still in place (as defined within the context of the primary outcome) versus *either* destination prosthesis no longer still in place or death.
That is, if the patient dies then we will consider them a failure, irrespective of whether the destination prosthesis was or was not in place at the time of death.

### Microbiological relapse b/w 100 days and 12 months {#sec-microbiological-relapse}

The occurrence of microbiological relapse, indicated by positive joint fluid or tissue culture for one or more of the index isolates, between 100 days and 12 months after platform entry, is subject to the competing risk of death. 
We will use a logistic regression model to analyse microbiological relapse to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibility of competing risks, this analysis actually yields a comparison of the presence of no microbiological relapse (with the prosthesis in place) versus *either* microbiological relapse or death (with or without the prosthesis in place).
That is, if the patient dies then we will consider them a failure, irrespective of whether there had been a microbiological relapse or not at the time of death.

### Microbiological reinfection b/w 100 days and 12 months

The occurrence of microbiological reinfection, indicated by positive joint fluid or tissue culture with a different organism to the index isolates, between 100 days and 12 months after platform entry, is subject to the competing risk of death. 
We will use a logistic regression model to analyse microbiological reinfection to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibility of competing risks, this analysis actually yields a comparison of the presence of no microbiological reinfection (with the prosthesis in place) versus *either* microbiological reinfection or death (with or without the prosthesis in place).
That is, if the patient dies then we will consider them a failure, irrespective of whether there had been a microbiological reinfection or not at the time of death.

### Time alive and free from revision procedure to 24 months {#sec-time-alive-24}

We will use a proportional-hazards model to analyse time alive and free from revision^[For the purposes of this outcome, we include amputation in the definition of revision.] to 24-months after platform entry.
Specifically, assuming no time-varying covariates or coefficients:

$$
\begin{aligned}
h(t) = h_0(t) \exp(x^\top \beta)
\end{aligned}
$$

where $h_0(t)$ is the baseline hazard at time $t$ (weeks) and $x^\top \beta$ denotes the linear predictor.
The baseline hazard will be modelled as a smooth function of time using splines, i.e. the above is modified such that

$$
\begin{aligned}
h(t) = \sum_{l = 1}^L \gamma_l M_l(t; \vec{k}, \delta) \exp(x^\top \beta)
\end{aligned}
$$

where $M_l(t; \vec{k}, \delta)$ denotes the $l^{\text{th}}$ basis term for a degree $\delta$ M-spline function evaluated at knots locations $\vec{k}$ and $\gamma_l$ denoting the $l^{\text{th}}$ M-spline coefficient.

::: {.callout-note}
The M-spline should include an intercept so that $h(t)$ is not constrained to zero at the origin and the coefficients are constrained to a simplex for identifiability.
todo - go back and review M-spline vs B-spline differences in approach, stability, fit for purpose and so on.
::: 

In the event of clear violation of proportional-hazards, appropriate model adjustments will be made as a sensitivity analysis.
Alternatively, other model formulations may be explored, such as an accelerated failure time models under a log-logistic or Weibull distributional assumptions.
Such models characterise effects in terms of survival times rather than hazards.

We will characterise treatment effects via the Restricted Mean Survival Time (RMST), defined as the area under the survival curve up to a specific time point.
The RMST can be interpreted as the average time to event during the defined period to 24-months.

::: {.callout-note}
todo - This deviates from the current estimand specification A.12 (Pg 39 ROADMAP Core Protocol_V1.1_01Aug2024_clean.pdf) which, I believe, intends a descriptive summary.
::: 


## Supportive (domain specific) analyses

The following sections detail analyses that are domain-specific, i.e. where the interest is in treatment effects that are restricted to a given domain.
For example, we are not interested in the effect of duration of antibiotic in the context of unplanned re-operation.

All these map to estimands are briefly outlined in the relevant DSAs.

::: {.callout-note}
todo - Get the DSA estimand specifications update to indicate that these are all up to 12 months.
:::

### Surgical domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the surgical domain.

#### Treatment success at 12 months

::: {.callout-note}
todo - finalise approach for this alternative to itt.
This is within the domain-specific section as we take a domain specific approach for the ICEs. Ditto with the other domains. Discuss.
:::


#### Unplanned re-operation

We will use logistic regression to analyse the occurrence of unplanned re-operation on the index joint more than 14 days after the initial definitive procedure.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

#### Dislocation of index joint

We will use logistic regression to analyse the occurrence of dislocation of the index joint on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

#### Unplanned or unexpected periprosthetic fracture

We will use logistic regression to analyse the occurrence of unplanned or unexpected periprosthetic fracture (either intraoperative or later on, requiring attendance at a hospital). 
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

### Antibiotic duration domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the antibiotic duration domain.

#### Treatment success at 12 months

todo - finalise approach for this alternative to itt.


#### Acute liver injury following platform entry to 90 days

We will use logistic regression to analyse the occurrence of acute liver injury to 90 days post platform entry. 
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

::: {.callout-note}
todo - Check whether this was meant to be 90 days **post commencement of antibiotics** rather than post platform entry, the former requiring a different approach.
:::


#### Laboratory-proven *Clostridium difficile* diarrhoea to x days

We will use logistic regression to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

::: {.callout-note}
todo - Check whether this should have a time limit on it. Presumably also 90 days...
:::

#### Antibiotics ceased due to suspected adverse reaction to 90 days

We will use logistic regression to analyse the occurrence of ceasing antibiotics due to other suspected adverse reaction between the time of domain entry to day 90.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

::: {.callout-note}
todo - What is meant by other?  Check whether this was meant to be 90 days post commencement of antibiotics.
:::

### Extended prophylaxis domain

#### Treatment success at 12 months

todo - finalise approach for this alternative to itt.


#### Time alive and free from any revision procedure to 12-months

::: {.callout-note}
todo - This seems like it would be domain agnostic. Not sure what it is doing in the DSA for ExP
:::

Time alive and free from any revision procedure on the index joint captured by a national joint replacement registry within 12 months of domain entry will be analysed via a proportional hazards survival model, using an analogous approach to that detailed in @sec-time-alive-24.



#### Time alive and free from any revision procedure to 24-months

::: {.callout-note}
todo - Again, this seems like it would be domain agnostic. Not sure what it is doing in the DSA for ExP
:::

Time alive and free from any revision procedure on the index joint captured by a national joint replacement registry within 24 months of domain entry will be analysed via a cause-specific hazard survival model, using an analogous approach to that detailed in @sec-time-alive-24.

#### Laboratory-proven *Clostridium difficile* diarrhoea to x days

::: {.callout-note}
todo - Check whether this should have a time limit on it. Presumably 90 days as per ab duration domain
:::

We will use logistic regression to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

#### Antibiotics ceased due to suspected adverse reaction to 90 days

::: {.callout-note}
todo - What is meant by other?  Check whether this was meant to be 90 days post commencement of extended prophylaxis.
:::

We will use logistic regression to analyse ceasing antibiotics due to *other* suspected adverse reaction between the time of domain entry to day 90 post platform entry.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

### Antibiotic choice domain

#### Treatment success at 12 months

todo - finalise approach for this alternative to itt.


#### Acute liver injury to day 100

::: {.callout-note}
todo - Check whether this should be **post commencement of rif**. 
:::

We will use logistic regression to analyse the occurrence of acute liver injury to day 100 post platform entry.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

#### Acute liver injurty to day 100

::: {.callout-note}
todo - Check if c.4 is a duplicate??
:::

#### Laboratory-proven *Clostridium difficile* diarrhoea to x days

::: {.callout-note}
todo - Check whether this should have a time limit on it. Presumably 90 days as per ab duration domain
:::

We will use logistic regression to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.

#### Antibiotics ceased due to suspected adverse reaction to 100 days

::: {.callout-note}
todo - Check why this is 100 days and others are 90.
Should these all be made the same?
:::

We will use logistic regression to analyse ceasing antibiotics due to other suspected adverse reaction between the time of domain entry to day 100 post platform entry.
The analyses will be based on all patients irrespective of any occurrence of specified or unspecifed ICEs.
The outcome is subject to the competing risk of death.


## Missing data

### Primary outcome variable

Given the use of a composite outcome variable for the primary analysis, missingness for the different composite elements could lead to different implications on the interpretation of the outcome.
The composite is ascertained through the use of hospital databases, followup with healthcare provider and/or patient and/or data linkage with death registries.

Treatment failure is indicated if any of the four composite elements are observed to fail. 
That is, if we see any of death, absence of clinical cure, ongoing antibiotic use or destination prosthesis absent, then the unit is a failure and whether other elements of the composite are observed or missing is irrelevant.

If direct evidence is missing of the patient being alive, this can be implied by the existence of any of observation of the other elements in the composite^[Although being alive is only up until the time of the surrogate observation, which may or may not be prior to the 12 month endpoint.].
If all other elements are missing and death cannot be confirmed by other sources then the unit could either be alive or dead (e.g. they might have died out of country although this seems highly improbable).
More likely is that if a patient cannot be found in a death registry, then they are alive.

Clinical cure suggests that antibiotics would no longer be required and therefore could possibly be a proxy for antibiotic status if it were missing, although this would not be definitive.
Conversely, if the status of clinical cure were missing and antibiotic status were known, then we could possibly take the fact that antibiotics were not being received to imply clinical cure.

Destination prosthesis status could be not be implied by other elements of the composite and therefore the outcome status cannot be confirmed if it is missing.

### Covariates

When missing, some covariates can be completed by implication.
For example, if region is missing, but site is available, region is known with certainty.

### Handling missingness

When missingness is completely at random or dependent on covariates, but not jointly dependent on the exposure and the outcome nor dependent on an unobserved variable unrelated to the exposure, then, for logistic regression, the parameter estimate for the exposure is unbiased under complete case analysis [@hughes2019; @McElreath2020, pg 503].
As such, a complete case approach will be used at the interim analyses and final analysis as the headline inference.
However, a sensitivity analysis will be run for the final analysis using multiple imputation that imputates both the missing components of the composite primary outcome variable and missing covariate values.
Missing values will be imputed using a fully conditional specification via multivariate imputation by chained equations [@vanbuuren2011].

## Software

Analyses will be implemented in R and Bayesian models will be implemented in Stan and/or JAGS as required with posterior distributions approximated using Markov chain Monte Carlo.
Also software used will be disclosed in the reports.

# Quantities of interest {#sec-statistical-quantities}

## Treatment effects

Interest is primarily geared towards the conditional effects of treatments under the various analyses.
In general, treatment is randomised so groups are exchangeable (i.e. the potential outcome associated with any treatment is independent of the treatment that was assigned).
For the surgical domain, the choice of revision is left to the clinician and those groups are not exchangeable.

::: {.callout-note}
To expand on the above, assume that when a unit is randomised to revision and the clinical decision of what type of revision to do is based solely on disease severity with more severe units receiving one-stage and those that are less severe receive two-stage.
This violates the exchangeability assumption in that if $\mathbb{E}[Y|T = 1] = y_1$ and $\mathbb{E}[Y|T = 2] = y_2$ (with $Y$ denoting the observed outcomes and $T = 1$, $T = 2$ denoting receipt of one and two-stage) then we would not obtain the same expectations if the sets of treatment units were switched.
In other words, $\mathbb{E}[Y(1) | T = 1] \ne \mathbb{E}[Y(1) | T = 2] \ne \mathbb{E}[Y(1)]$ and $\mathbb{E}[Y(2) | T = 1] \ne \mathbb{E}[Y(2) | T = 2] \ne \mathbb{E}[Y(2)]$.
To remedy this, we adjust for a covariate set (in this example, disease severity but in the primary analysis we adjust for revision type preference and additional patient characteristics) with the goal of achieving conditional exchangeability.
:::


The following descriptions relate to the calculation of treatment effects (conditional log-odds-ratios) for the primary analysis.
All domains adopt g-computation and a Bayesian bootstrap that characterises the uncertainty in the joint covariate distribution.

### Surgical domain 

For the surgical domain, we calculate the effect of revision relative to debridement as the difference between a weighted sum of the log-odds of treatment success under one-stage and two-stage revision minus the log-odds of treatment success under debridement.

<!-- (Riemann-Stieltjes) -->

Specifically, we approximate the following integrals based on the fitted values for the patients in the late-acute silo:

$$
\begin{aligned}
\mathbb{E}[\hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l) d \hat{P}_L(l) \\
\mathbb{E}[\hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l) d\hat{P}_L(l) \\
\mathbb{E}[\hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l) d\hat{P}_L(l) \\
\end{aligned}
$$

where $\hat{\eta}$ denotes the linear predictor function, $d_k$ denotes the interventions in the surgical ($k=1$), duration ($k=2$) and extended prophylaxis domains ($k=3$) with the surgical domain ($d_1$) indexes corresponding to debridement, one-stage and two-stage respectively. 
Preference for surgical type under revision is denoted by $r$ and, finally, $l$ denotes the remaining covariate set including preference where it is not explicitly conditioned on and **other domain level interventions** not fixed for the purposes of the comparison, site, time effects etc.
We compute the effect of revision relative to debridement as:

$$
\begin{aligned}
\Delta_{d_1[1]} &= \mathbb{E}[\hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l)]\mathbb{E}[r = 1] + \\ 
  & \quad \mathbb{E}[\hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l)]\mathbb{E}[r = 2]  - \\ 
  & \quad \mathbb{E}[\hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l)]
\end{aligned}
$$

where $\Delta_{d_1[1]}$ denotes the log-odds-ratio comparison of interest^[There is currently only one comparison of interest for each domain but the index gives us the ability to refer to others should the need arise.], $\mathbb{E}[r = 1]$ and $\mathbb{E}[r = 2]$ are the relevant weights based on the observed distribution of preference for revision type in the sample.

::: {.callout-note}
Question - Would it be more sensible to compute $\mathbb{E}[Y|\dots]$ from the inverse link transformed linear predictor and then compute the log-odds ratios from there or is the above acceptable???
:::

### Antibiotic duration domain 

The antibiotic duration domain treatment effects are simpler to estimate than those in the surgical domain in that we can calculate the effect of 6 weeks of backbone antibiotic relative to 12 weeks directly.
To do so, we use methods analogous to those detailed above restricting to the subset revealed to randomised antibiotic duration, all of which would have received a one-stage revision and who would therefore have not entered into the extended prophylaxis domain.

### Extended prophylaxis domain 

For the extended prophylaxis domain we calculate the effect of 12 weeks of extended prophylaxis relative to none again using methods analogous to those detailed above.
The estimation procedure is restricted to the subset revealed to randomised extended prophylaxis, all of which would have received a two-stage revision and who would therefore have not entered into the antibiotic duration domain.

### Antibiotic choice domain

For the antibiotic choice domain we calculate the effect of the addition of rifampacin relative to none again using methods analogous to those detailed above.
The estimation process is restricted to the subset revealed to randomised antibiotic choice, with no restrictions on the entry into the other domains.



# Decision procedures

## Overview

Trial decisions are made based on probabilities associated with the comparisons of interest as characterised by the model parameters discussed earlier.
In its current format, the trial considers:

+ superiority - indicating that an intervention is beneficial relative to a comparator
+ non-inferiority - indicating that an intervention is no worse than some clinically relevant threshold to a comparator 
+ futility - indicating a low probability with respect to a superiority or non-inferiority assessment, as applicable

The mathematical definitions of these quantities are provided below and a table of the thresholds currently in use is defined in @tbl-dec-thres.

```{r}
#| echo: FALSE
#| label: tbl-dec-thres
#| tbl-pos: H
#| tbl-cap: "Decision thresholds"




d_tbl <- tribble(
  ~ Domain, ~ Quantity, ~ Threshold, ~ Probability,
  "Surgical", "Superiority \n revision vs debridement", "$>0$", "$\\ge 0.99$",
  "Surgical", "Futility \n revision vs debridement", "$>\\log(1.2)$", "$\\le 0.05$",
  "Antibiotic duration", "Non-inferiority \n 6 weeks vs 12 weeks", "$> \\log(1/1.2)$", "$\\ge 0.99$",
  "Antibiotic duration", "Futility \n 6 weeks vs 12 weeks", "$<\\log(1/1.2)$", "$\\le 0.2$",
  "Extended prophylaxis", "Superiority \n 12 weeks vs none", "$>0$", "$\\ge 0.99$",
  "Extended prophylaxis", "Futility \n 12 weeks vs none", "$>\\log(1.2)$", "$\\le 0.05$",
  "Antibiotic choice", "Superiority \n rifampacin vs none", "$>0$", "$\\ge 0.99$",
  "Antibiotic choice", "Futility \n rifampacin vs none", "$>\\log(1.2)$", "$\\le 0.05$"
  )


# see https://gt.rstudio.com/reference/fmt_markdown.html
gt_tbl <- gt(d_tbl, groupname_col = "Domain",
    row_group_as_column = TRUE) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  fmt_markdown() |>
  cols_width(
    Domain ~ pct(15),
    Quantity ~ pct(45),
    Threshold ~ pct(15),
    Probability ~ pct(15)
  ) |>
  tab_options(table.font.size = "80%")

gt_tbl

```


The actions that occur when decision threshold are met have been detailed in the core protocol and will not be duplicated here.
However, any occurrence of a futility decision requires that a subgroup analysis be performed as per the populations listed in @sec-subgroups using the methods detailed in @sec-subgroup-analyses for the relevant domain(s).

For a futility decision to hold, it is expected that all relevant subgroups would show futility.

::: {.callout-note}
Unsure whether it is sensible to be examining all subgroups in order to determine the outcome of futility, especially given the number of subgroups defined.
:::

## Superiority

Superiority implies that an intervention has high probability of being beneficial relative to a comparator intervention.
Generally, superiority is a probability assessment against a zero reference.
For any of the treatment effect parameters obtained from the primary analysis results we define:

$$
\begin{aligned}
\mathbb{I}_{d_k[c]}^\text{sup} = \text{Pr}(\Delta_{d_k[c]} > s_{d_k[c]}) \ge \gamma_{d_k[c]}^\text{sup}
\end{aligned}
$$

as treatment superiority where $\mathbb{I}_{d_k[c]}^\text{sup}$ is a boolean indicator of superiority, for the comparison indexed by $c$ within the $d_k$ domain relative to a reference level $s_{d_k[c]}$ (generally zero) at a probability greater than or equal to $\gamma_{d_k[c]}^\text{sup}$.

## Non-inferiority

Non-inferiority implies that an intervention has a high probability of being no worse than some pre-specified clinical threshold relative to the comparator intervention.
Generally, non-inferiority is a probability assessment against $\log(1/1.2)$.
For any of the treatment effect parameters obtained from the primary analysis results we define:

$$
\begin{aligned}
\mathbb{I}_{d_k[c]}^\text{ni} = \text{Pr}(\Delta_{d_k[c]} > n_{d_k[c]}) \ge \gamma_{d_k[c]}^\text{ni}
\end{aligned}
$$

as treatment non-inferiority where $\mathbb{I}_{d_k[c]}^\text{ni}$ is a boolean indicator of non-inferiority, for the comparison indexed by $c$ within the $d_k$ domain relative to a reference level $n_{d_k[c]}$ at a probability greater than or equal to $\gamma_{d_k[c]}^\text{ni}$.

## Futility

Futility in relation to either a superiority or a non-inferiority assessment implies that an intervention has low probability relative to the comparator intervention with respect to that assessment.

For any of the treatment effect parameters obtained from the primary analysis results we define:

$$
\begin{aligned}
\mathbb{I}_{d_k[c]}^\text{fut} = \text{Pr}(\Delta_{d_k[c]} > f_{d_k[c]}) \le \gamma_{d_k[c]}^\text{fut}
\end{aligned}
$$

as treatment futility where $\mathbb{I}_{d_k[c]}^\text{fut}$ is a boolean indicator of futility with respect to the relevant assessement type, for the comparison indexed by $c$ within the $d_k$ domain relative to a reference level $f_{d_k[c]}$ at a probability greater than or equal to $\gamma_{d_k[c]}^\text{fut}$.


# Adaptation

## Adaption considerations

Three possible adaptations are currently identified, namely early stopping (due to superiority, non-inferiority or futility), the addition of interventions within existing domains and the addition of entirely new domains.


# Simulations

Simulations are run to evaluate the operating characteristics of the study with a particular focus on the repeat sample error rate (type-I errors) and 

test


<!-- The treatment regimen under evaluation is the randomised and revealed surgical treatment in combination with randomised and non-randomised treatments associated with other domains in the subset of patients that would adhere to all surgical domain interventions but that may have had specified or unspecified ICE(s) associated with other domains. -->


<!-- No problems Mark, -->
<!-- In the situation you mention, I would analyse the crossed over patient according to their original assignment because they had no choice but to cross over. So, in my mind, it is still a type of ‘hypothetical’ estimand, but one in which you only censor those who stopped or crossed over but who could have, in theory, stayed on their original assignment. The hypothetical estimand is the effect of the assignment (not the treatment) in which everyone who could have adhered, did adhere. Obviously the determination about whether they ‘needed to’ stop or cross-over may be subjective, which is a limitation. -->
<!-- Tom -->

<!-- From: Mark Jones <mark.jones1@sydney.edu.au>  -->
<!-- Sent: Wednesday, July 3, 2024 1:07 PM -->
<!-- To: Thomas Snelling <tom.snelling@sydney.edu.au> -->
<!-- Cc: Daniela Vargas <daniela.vargas@sydney.edu.au> -->
<!-- Subject: Re: roadmap - notes on itt/pp etc -->

<!-- Thanks for following up Tom, -->

<!-- I had to deal with the reviewers comments for stop yesterday and now am going through the manuscript for Michelle to try and get rid of that. Long story short is that it will probably be Friday or early next week before I have anything useful to go through. -->

<!-- I have thought about what you said for the view treatment effects (vs assignment effects) and wonder if a hypothetical estimand is the best option in that for someone with a loose joint assigned to dair since there is no option other than to cross over. Perhaps a principal stratum perspective might be more suitable in that instance. But I will have a look through the paper that you sent and have a think about it. My thought at the moment is that a mix of strategies is maybe necessary to address the different ices. There has been some work on using a mix, but I am not sure how broadly it is applied. -->

<!-- Regards -->
<!-- Mark -->


<!-- Mark Jones | Senior Biostatistician -->
<!-- Health and Clinical Analytics Lab, Sydney School of Public Health -->

<!-- THE UNIVERSITY OF SYDNEY -->
<!-- E mark.jones1@sydney.edu.au | W http://sydney.edu.au -->

<!-- Hi Mark. I have a meeting at 4-5pm today, but otherwise pretty flexible. Let me know if you’d like to schedule time to discuss this. -->
<!-- Tom -->

<!-- From: Thomas Snelling  -->
<!-- Sent: Monday, July 1, 2024 6:12 PM -->
<!-- To: Mark Jones <mark.jones1@sydney.edu.au> -->
<!-- Subject: RE: roadmap - notes on itt/pp etc -->

<!-- Actually, this paper might be more illustrative https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10505414/ -->
<!-- Tom -->

<!-- From: Thomas Snelling  -->
<!-- Sent: Monday, July 1, 2024 4:28 PM -->
<!-- To: Mark Jones <mark.jones1@sydney.edu.au> -->
<!-- Subject: RE: roadmap - notes on itt/pp etc -->

<!-- Thanks for this Mark. I’ve had a quick read through this. Useful to share this to prompt our collective thinking, but I expect we will need to be fairly directive with Josh about what we advise. -->
<!-- I think the appropriate estimand for the PP analysis is the hypothetical difference in effect that would be observed if everyone who could adhere to treatment actually did (and those couldn’t defaulted to something else) and where everyone who could in theory be followed up (i.e. because they weren’t dead and didn’t have an amputation), actually were. -->
<!-- In this case, we (only) censor those who stop adhering to their assigned treatment (but who could have reasonably adhered), and then effectively weight those who remain uncensored according to their inverse probability of censoring to minimise risk of confounding by factors that are both predictive of censoring and predictive of the outcome. Importantly, those who stopped or switched because they had no choice (eg loose or stuck joint), remain in their assigned strategy if though they stopped/ switched. -->
<!-- I’ve had a quick scan of the literature and found this paper. At a glance it looks like this aligns with what they advocate? Reducing Bias in Estimates of Per Protocol Treatment Effects: A Secondary Analysis of a Randomized Clinical Trial | Research, Methods, Statistics | JAMA Network Open | JAMA Network -->
<!-- https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2807637 -->

<!-- Regards, -->
<!-- Tom -->

<!-- The hypothetical strategy for handling ICEs is not appropriate here as  -->



# References

<!-- Needs to have a citation for this to work otherwise you will get the old \end{CSLReferences} error  -->

