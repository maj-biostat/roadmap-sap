---
title: Statistical Analysis Plan
subtitle: |
    ROADMAP: RandOmised Arthroplasty infection worlDwide Multidomain Adaptive Platform trial - analysis plan
description: |
    Investigator initiated, Randomised Embedded Multifactorial Adaptive Platform (REMAP) trial, conducted across multiple hospitals in several regions of the world.
date: last-modified
date-format: "D MMMM YYYY"
author: 
  - name: Mark Jones
    id: mj
    email: mark.jones1@sydney.edu.au
  - name: James Totterdell
    id: jt
    email: james.totterdell@sydney.edu.au
version: 0.1
sponsor: University of Newcastle, NSW, Australia
protocol-number: Version 1.1  01AUG2024
registration: todo
hrec: todo
ci1: Professor Joshua Davis  
ci2: Professor Laurens Manning
editor: source
bibliography: etc/refs.bib
csl: etc/elsevier-harvard.csl
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
)
```

```{r, echo = F}
#| echo: false

# uml digs
library(nomnoml)
library(ggplot2)
suppressPackageStartupMessages(library(data.table))
library(tibble)
library(gt)
library(kableExtra)
suppressPackageStartupMessages(library(qs))
library(git2r)
```

{{< pagebreak >}}

::: summary
|     |        |
|:----|:------------|
|Study title:  |  ROADMAP: RandOmised Arthroplasty infection worlDwide Multidomain Adaptive Platform trial |
|Intervention: |  Surgery type, backbone antibiotic duration, extended prophylaxis, antibiotic type |   
|Study design:  |   Randomised Embedded Multifactorial Adaptive Platform trial | 
|Sponsor:  |    University of Newcastle, NSW, Australia | 
Protocol: |  Version 1.1  01AUG2024 |
|Registration:  |    todo | 
|HREC:  |   todo | 
|Study date of first consent:  |   todo | 
|Principal coordinating investigators:  |   Professor Joshua Davis  and Professor Laurens Manning | 
:::

<!-- 
Note that the above relies on the pandoc extension implemented in the lua file 
in the etc directory. It additionally relies on the presence of a custom style
in word called study summary. It will currently only work for word (because I
cannot be bothered to implement it in anything else at the moment).
-->


{{< pagebreak >}}

# Version history {.unlisted .unnumbered}

| Version    |   Date     | Change    |   Reason     |
|:----|:------------|:----|:------------|
| 0.1 | 09/2024 | First version | N/A |
| 0.2 | 12/2024 | Review 1 | Edits based on initial comments from TS and JT |


{{< pagebreak >}}

# Repository status {.unlisted .unnumbered}

\footnotesize
```{r}
#| echo: false
repo <- repository(path = ".")
summary(repo)
```
\normalsize

{{< pagebreak >}}

# Preface {.unlisted .unnumbered}

This statistical analysis plan (SAP) outlines the planned data processing and analysis approach for ROADMAP.
The SAP is an operational document that will be updated, as necessary, prior to each analysis.

For each analysis conducted, there will be a dedicated SAP release within the github repository and the applicable release will be referenced within the analysis report.

The SAP references:

+ ROADMAP Core Protocol_V1.1_01Aug2024
+ ROADMAP Surgical Late Acute DSA. V1.1_01Aug2024
+ ROADMAP AB Duration DSA_Part A. V1.1_01Aug2024
+ ROADMAP AB Duration DSA_Part B. V1.1_01Aug2024
+ ROADMAP AB Choice DSA_V1.1_01AUG2024
+ ROADMAP Registry Appendix. V1.1_01Aug2024

# Introduction

ROADMAP is a platform trial for pragmatically evaluating the effectiveness of multi-modal interventions used in the treatment of prosthetic joint infection (PJI).
The primary application is to inform clinical decision making at the point of care.
It is an international study run in Australia, New Zealand, Canada and the UK with partners from the academic sector.
It is also designed to be a perpetual study and uses a single Master Protocol to dictate procedures and conduct.

Each set of interventions (domain) are detailed within separate Domain Specific Appendicies (DSA) to the Master Protocol. 
Conclusions and reports will be produced separately with some participant outcomes being used in multiple reports, thereby potentially contributing to the inference associated with several interventions.
All DSAs will be evalauated under a single model specification and a single analysis plan (this document) is used cover all DSAs.

## Background motivating research question(s) {#sec-background}

ROADMAP is motivated by several high-level questions relating to the management of prosthetic joint infections, specifically:

1. For patients with *late-acute*^[Page 15 of ROADMAP Core Protocol_V1.1_01Aug2024_clean.pdf says "For early post- operative infections". Think this would be clearer to refer to cohort.] post-operative infections, is it better to keep the existing prosthetic joint and clean the infection or to replace the joint entirely?
2. What is the most effective duration of backbone antibiotics for patients receiving *one-stage revision*^[Page 15 of ROADMAP Core Protocol_V1.1_01Aug2024_clean.pdf says "What is the most effective duration of antibiotics after surgery?". Think this would be clearer to refer specifically to the type of surgery.] surgery?
3. Is it better to include rifampicin (or not) in the backbone antibiotic treatment regimen?

Each of these will be evaluated in relation to the primary outcome, which is a composite outcome defined at 12-month post platform entry.
Specifically, the co-occurrence of the following states (paraphrased from the protocol, which has a more complete definitions, see section 6.6 Trial endpoints in the Core Protocol):

1. Alive
2. No evidence of infection
3. No ongoing use of antibiotics for the index joint 
4. Destination prosthesis in place 

Missing elements may impact the construction of the composite primary outcome as missingness does not equate definitively to either negation or confirmation.
Missingness could arise for several reasons, one of which is that the source records are dated outside the permissible time windows.
In the context of the analyses, the main reference time window is not earlier than 12 months post platform entry and up to 13 months post platform entry, although variations on this exist e.g. for antibiotic use.

## Objectives and endpoints

The primary goal of ROADMAP trial is to examine the effect of a range of interventions in platform-eligible patients with PJI on treatment success as defined earlier in @sec-background.
@tbl-obj provides a high-level summary of each of the domain objectives.
Additional detail can be found in the protocol.

```{r}
#| echo: FALSE
#| label: tbl-obj
#| tbl-pos: H
#| tbl-cap: "ROADMAP domain-level analytic objectives"

d_tbl <- tribble(
  ~ domain, ~ objective, ~ endpoint, 
  "Surgical" , "Determine whether revision (understood as a sample-weighted average of the effects of one and two-stage revision) is more effective than debridement for treating prosthetic joint infections in late-silo units."  , "Treatment success at 12 months (alive, no evidence of infection, no antibiotics for PJI, destination prothesis in place)." ,
"Antibiotic duration" , "Determine whether 6 weeks of backbone antibiotic is non-inferior to 12 weeks in curing prosthetic joint infections in units receiving one-stage revision." , "Treatment success at 12 months." ,
"Extended prophylaxis" , "Determine whether 12 weeks of extended prophylaxis is more effective than none for treating prosthetic joint infections in units receiving two-stage revision.", "Treatment success at 12 months." ,
"Antibiotic choice" , "Determine whether the addition of rifampicin is more effective than none for treating prosthetic joint infections in units where one or more of the causative organisms is a Gram-positive type of interest (or infection is culture negative)." , "Treatment success at 12 months." 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(15),
    objective ~ pct(50),
    endpoint ~ pct(35)
  ) |>
  cols_label(
    domain = "Domain",
    objective = "Objective",
    endpoint = "Endpoint"
  ) |>
  tab_options(table.font.size = "65%")

gt_tbl
```


## Estimands {#sec-estimands}

One of the goals of the estimand framework is to create a bridge between the clinical question and the statistical analyses.
In the following sections, we provide further detail to the specifications provided in the core protocol and DSAs with a focus on the treatment regimen, the population summaries and the intercurrent events.
Only the primary estimands have been detailed as the statistical approach to the supportive analyses, that being a standard per-protocol analysis, has well known limitations.

### Primary estimand {#sec-primary-estimand}

A primary estimand, which aims to introduce the treatment-level comparisons for all the domains, is defined in the core protocol.
The DSAs introduce a domain-specific primary estimand by adding some detail on the treatment arm comparisons.
For all domains, the primary estimand adopts a mixed approach to handling ICEs.
The majority of ICEs are handled via a treatment policy, which parallels the intention to treat (ITT) perspective, but the outcome definition implies a composite strategy for death^[While death (occurring prior, during or after the occurrence of the intervention) may ordinarily be considered an intercurrent event in this clinical setting, it has been accounted for by its inclusion in the primary outcome definition, i.e. we implicitly adopt a composite strategy for death. Similarly, secondary or rescue surgery leading to the removal of a prosthetic is accounted for by its inclusion in the primary outcome definition and again implies the composite strategy. These subtleties have to be kept in mind when interpreting and generalising the results.].
In general, all ICEs are effectively considered to be part of the treatment regimen of interest and therefore receive no further consideration, @Mallinckrodt2020.

#### Estimand B.1 (surgical intervention)

<!-- In all cases, interest is in the main effects. -->

**High-level overview:**

The estimand considers the effect of removing the infected joint (irrespective of whether knee or hip) versus cleaning and leaving the joint in place on treatment success at 12 months (primary outcome), specifically within the cohort of patients with late-acute infection and where treatment in other domains are given according to the trial design dependencies and usual practice when in receipt of DAIR and when in receipt of revision (and for the type of revision adopted).

**Treatment regimen:**

The protocol definitions for the surgical interventions are given in the DSA for the Surgical strategy domain, which is specific to the cohort of patients with late-acute infection.
Those definitions provide detail for the protocolised interventions under consideration.
For example, at a minimum, debridement and implant retention (DAIR) must include an open approach, exchange of modular components, removal of the synovial lining of the joint and irrigation (see DSA Surgical Late-acute, section 7.3 for further detail).

The randomised treatment arms comprise DAIR and surgical revision where the clinician is permitted to self-select the type (one or two-stage) when a patient is assigned to the revision group.
The type of revision is determined following the surgical procedure where the surgeon is required to state whether there are no plans for a second stage operation (implying a one-stage revision, see DSA for AB duration part A, section 7.2) or there is an intention to have a second stage procedure (implying two-stage revision, see DSA AB Duration part B, section 6.2.1).
Receipt of each of the surgical interventions and specific revision types has implications for the care revealed and admitted under other domains bar the antibiotic choice domain, although all obviously necessitate survival (a post-randomisation event) through the surgical procedure.

Receipt of DAIR precludes entry into the backbone antibiotic duration domain and extended prophylaxis domain.
Patients receiving DAIR would therefore receive a form of non-randomised treatment (usual care) for their backbone antibiotic duration.  
However, given that DAIR is a single stage procedure, these patients have no logical progression to extended prophylaxis (as is defined for two-stage revision patients^[For the purposes of the study, extended prohylaxis is only relevant following the second stage of the revision procedure]).
DAIR patients also receive an antibiotic choice domain assignment (or non-randomised care).

Receipt of one-stage revision permits (but does not require) entry into the backbone antibiotic duration domain and precludes entry into the extended prophylaxis domain.
Similar to DAIR patients, these patients have no logical progression to extended prophylaxis as it is defined for two-stage revision patients.
Therefore, patients receiving one-stage revision will also receive either non-randomised treatment (usual care), 12 weeks or 6 weeks backbone antibiotic duration along with an antibiotic choice domain assignment.

Receipt of two-stage revision permits (but does not require) entry into the extended prophylaxis domain and precludes entry into the backbone antibiotic duration domain.
Therefore, patients receiving two-stage revision will either receive non-randomised treatment, no-extended prophylaxis or 12 weeks extended prophylaxis duration.
These patients will also receive non-randomised treatment (usual care) for the backbone antibiotic duration along with an antibiotic choice domain assignment.

**Intercurrent events:**

Likely intercurrent events for the surgical domain and the approaches used to handle them are summarised in @tbl-ice-b1.
The treatment policy strategy allows for the randomised and revealed surgical treatment in addition to a specific combination of randomised treatments and non-randomised treatments associated with other domains, and, with any occurrence of specified or unspecified ICE(s).
The comparison of groups allow for lack of adherence, adding or switching, changes in background medication.
The estimand is therefore not associated with a specific single treatment protocol, but rather reflects a mix of procedures that commonly occur when undertaking DAIR or revision.

{{< pagebreak >}}


```{r}
#| echo: FALSE
#| label: tbl-ice-b1
#| tbl-pos: H
#| tbl-cap: "Surgery domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "B.1(i1)" , "DAIR"  , "If prosthesis is found to be loose when the joint is opened, the surgeon would routinely override allocation and do a revision. Expected in x% of patients." , "Switchover" , "Treatment policy" ,
"B.1(i2)" , "Revision"  , "If the patient becomes clinically unstable prior to or during the operation, the surgeon may abandon the attempt at revision and revert to a DAIR. Expected in x% of patients." , "Switchover" , "Treatment policy" ,
"B.1(i3)" , "Revision"  , "If one or more components of the prosthesis are too difficult to remove, the surgeon may abandon the attempt at revision and revert to a DAIR. This is more likely with a non-cemented hip than with a cemented hip or a knee. Expected in x% of patients." , "Switchover" , "Treatment policy"  
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Treatment",
    ice = "ICE",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "65%") |> 
  tab_footnote(
    footnote = md("Switchover will not generally result in the outcome variable being missing (assuming the patient followup continues to completion) but does affect the interpretation of the result due to dilution of the treatment effect. For an (admittedly contrived) example, in a two-arm trial, if the majority of units assigned to the first treatment switched over to the second treatment and none of the units assigned to the second treatment switched then an ITT/treatment policy approach would be comparing groups of units that effectively received the same treatment."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )

gt_tbl
```


**Summary measure:**

The population-level summary measure is the absolute risk difference with respect to treatment success comparing revision (defined as both one-stage and two-stage procedures) and DAIR in conjunction with the set of treatments in other domains as determined by the design and usual care by the relevant surgical procedure assigned.

**Main estimator:**

A Bayesian multivariable logistic regression model is used to characterise unit responses for the primary outcome across all domains, see @sec-primary-analysis.
The approach is intended to (1) accommodate clinician-choice with regards to revision type and (2) allow for the dependency between specific revision types and entry into the antibiotic duration and extended prophylaxis domains with differing baseline log-odds.

The population-level summary is obtained via g-computation, which provides a counterfactual comparison across the relevant cohort.
We estimate the unit-level probability of treatment success under each surgical intervention type and average over the sample.
A Bayesian bootstrap procedure accounts for uncertainty in the covariate distribution.
The counterfactual assignments across the domains are obtained by reference to the baseline randomisation.
The overall revision effect is the risk difference between a weighted combination of the one and two-stage revision risk and DAIR where the weights arise from the sample distribution for the surgical revision preference under assignment to revision, obtained at baseline and restricted to the late acute silo.
Any varying effects will be fixed at zero rather than marginalised.

**Data useful for estimand:**

The ability to compute the estimand assumes we have access to each patients' unconditional random allocation, across all domains, which is made at baseline (i.e. at platform entry). 
Crucially, patients' allocated to DAIR in the surgical domain will be randomised within the backbone antibiotic duration and extended prophylaxis duration domains, but these allocations would likely never be revealed.

Surgical preference for revision type is required for all participants, at baseline.
Specifically, we require an answer to "Assuming the patient receives revision, what type of revision procedure is preferenced at this time?"

Any ICE should be detailed with respect to reason, timing and implications.

Patients should be followed up after the occurrence of an ICE to obtain detail on the final status of the primary outcome.

**Missing data:**

Missing data might arise due to limitations in identifying clinical records, formal requests from patients to completely withdraw from the study (including use of data), loss to follow up due to relocation, human error etc.
Additionally, components of the composite outcome may not be available in the clinical records (e.g. ongoing use of antibiotics for the specific reason of managing prosthetic infection might not be adequately recorded).
Missingness will be assumed to be low and at random across all variables (and/or variable components) such that imputation could, in principle, be undertaken by conditioning on observed patient characteristics.
Under the assumption that the missingness is not simultaneously dependent on the outcome and exposure, multiple imputation is not technically required to obtain unbiased estimates of the treatment effect.
Additionally, a complete-case (likelihood-based) analysis will yield unbiased estimates of the treatment effects.
As such, multiple imputation will not be adopted for the primary outcome variable.
Where it occurs, missingness in covariates will be addressed by deduction (where possible) or fixed imputation scheme (if reasonable) the details of which are to be disclosed in analysis reports and publications.

**Sensitivity:**

Tipping point sensitivity analysis and multiple imputation schemes may be considered and implemented at the discretion of the analyst, the details of which being disclosed in the reporting.

#### Estimand D.1 (antibiotic duration intervention)

**High-level overview:**

The estimand considers the effect of the backbone antibiotic duration on treatment success at 12 months, specifically whether 6 weeks (a short duration) of backbone antibiotic is non-inferior to 12 weeks (a long duration) in patients surviving the first stage of revision with no plans for a secondary stage and where treatment in other domains are given according to the trial design and usual practice under entry into the backbone antibiotic duration domain.

The estimand is effectively addressing a sub-study question (for which the participant characteristics may deviate from the platform reference group, e.g. less severe disease) that is based on patients receiving and surviving a specific type of revision procedure.

**Treatment regimen:**

Participants are randomised to 42 +/- 7 days (6 weeks) or 84 +/- 7 days (12 weeks) backbone antibiotic, selected according to organism and patient factors.
Further details on the protocol definitions of the interventions are provided in the relevant DSA (DSA for AB duration part A, section 7.3.1).

Entry into the domain is determined based on receipt and confirmation of one-stage revision, which occurs on the conclusion of the surgery by a surgeon indicating that no secondary stage is intended (see DSA for AB duration part A, section 7.2).

Eligibility for the backbone antibiotic duration domain precludes entry into the extended prohphylaxis domain, as there is no progression to a secondary stage procedure (per the form used under two-stage revision) for this cohort of patients.
Patients entering into the backbone antibiotic duration domain also receive an antibiotic choice domain assignment (or non-randomised care).

```{r, echo = F, eval = F}

# Code for playing around with entry, conditional on survival
# into the duration domain.

library(data.table)
library(pbapply)
library(ggplot2)

N_sim <- 1e3
mc_cores <- 4

d_r <- rbindlist(pbapply::pblapply(X=1:N_sim, cl = mc_cores, FUN = function(ix){

  N <- 10000
  d_1 <- data.table(
    # dair/rev
    d1 = rbinom(N, 1, 0.5),
    d2 = rbinom(N, 1, 0.5)
  )
  d_1[, sev_dis := rnorm(N, 0, 1)]
  
  d_1[, eta_death_surg := -2 + 0 * d1 + 0.3 * sev_dis]
  d_1[, death_in_surg := rbinom(N, 1, plogis(eta_death_surg))]
  
  # survivors receiving rev are revealed to dair
  # these are going to be disease severity lower than average
  d_1[death_in_surg == 0 & d1 == 1, .(.N, mu_sev = mean(sev_dis)), keyby = d2]
  
  # d2 (duration) only affects those assigned to revision hence the d1*d2
  d_1[death_in_surg == 0, eta_death_fu := -2 + 0*d1 + 0.2*d1*d2]
  d_1[death_in_surg == 0, death_at_fu := rbinom(.N, 1, plogis(eta_death_fu))]
  d_1[death_in_surg == 1, death_at_fu := 1]
  
  d_2 <- d_1[, .(y = sum(death_at_fu), .N), keyby = .(d1)]
  d_2[, p_obs := y/N]
  
  d_3 <- d_1[, .(y = sum(death_at_fu), .N), keyby = .(d2)]
  d_3[, p_obs := y/N]
  
  d_out_1 <- data.table(
    domain = "d1", 
    p_1 = d_2[d1 == 1, p_obs],
    p_0 = d_2[d1 == 0, p_obs]
    )
  d_out_1[, rd := p_1 - p_0]
  
  d_out_2 <- data.table(
    domain = "d2", 
    p_1 = d_3[d2 == 1, p_obs],
    p_0 = d_3[d2 == 0, p_obs]
    )
  d_out_2[, rd := p_1 - p_0]
  
  d_4 <- d_1[, .(y = sum(death_at_fu), .N), keyby = .(d1, d2)]
  
  # again, d2 only relevant for revision case
  f1 <- glm(death_at_fu ~ d1 + d1:d2, data = d_1, family = binomial)
  
  d_ctl <- copy(d_1)
  d_ctl[d1 == 1 & death_in_surg == 0, d2 := 0]
  
  pred_p_0 <- predict(
    f1, 
    newdata = d_ctl[d1 == 1 & death_in_surg == 0], 
    type = "response")
  
  d_ctl <- copy(d_1)
  d_ctl[d1 == 1 & death_in_surg == 0, d2 := 1]
  
  pred_p_1 <- predict(
    f1, 
    newdata = d_ctl[d1 == 1 & death_in_surg == 0], 
    type = "response")
  
  # (pred_p_1/(1-pred_p_1))  / (pred_p_0/(1-pred_p_0))
  
  
  
  rbind(d_out_1, d_out_2)

}), idcol = "id_sim")

#
d_r[, .(mu_beta = mean(beta)), keyby = .(domain)]

# risk difference
d_r[, .(mu_rd = mean(rd)), keyby = .(domain)]

ggplot(d_r, aes(x = rd)) +
  geom_density() +
  facet_grid(~domain)

```


**Intercurrent events:**

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-d1 where the treatment policy ICE strategy aims to establish the effect of treatment assignment.

```{r}
#| echo: FALSE
#| label: tbl-ice-d1
#| tbl-pos: H
#| tbl-cap: "Antibiotic duration domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "D.1(i1)" , "6 wk"  , "If patient has slow improvement, recrudescence of infection or need to return to theatre then clinicians may choose to prolong antibiotic therapy. Expected in x% of patients." , "Extension to therapy" , "Treatment policy" ,
"D.1(i2)" , "12 wk"  , "Adverse effects of antibiotics or patient discharge/relocation may lead to early termination of therapy. Expected in x% of patients." , "Discontinuation" , "Treatment policy" 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Treatment",
    ice = "ICE",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "65%")  |> 
  tab_footnote(
    footnote = md("Extended therapy in the 6 week group would make the responses more similar to the 12 week group leading to increase likelihood of non-inferiority decision, i.e. conclusions may anti-conservative."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )  |> 
  tab_footnote(
    footnote = md("Discontinuation in the 12 week group would make the responses more similar to the 6 week group."),
    locations = cells_body(
      columns = class,
      rows = 2
    )
  )

gt_tbl
```

The treatment regimen under evaluation is thus the randomised and revealed antibiotic duration treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.

**Summary measure:**

The population-level summary is an absolute risk difference with respect to treatment success comparing 6 weeks backbone antibiotic and 12 weeks in patients receiving one-stage revision in conjunction with the treatments in other domains as determined by the design dependencies and usual care.

**Main estimator:**

Similar to the estimator for the surgical domain, the population-level summary is obtained via g-computation, which provides a counterfactual comparison across the relevant cohort, here restricted to patients in recipt of one-stage revision under a landmark analysis. 
Again, we estimate the unit-level probability of treatment success under each randomised intervention and average over the sample.
A Bayesian bootstrap procedure to account for uncertainty in the covariate distribution.

**Data useful for estimand:**

Per the considerations and definitions for B.1.

**Missing data:**

Per the considerations and definitions for B.1.

**Sensitivity:**

Per the considerations and definitions for B.1.

#### Estimand E.1 (extended prophylaxis intervention)

**High-level overview:**

The estimand considers the effect of the extended prophylaxis on treatment success at 12 months, specifically whether 12 weeks of extended prophylaxis is more effective than none following the second stage within a two-stage revision procedure and where treatment in other domains are given according to the trial design dependencies and usual practice when in receipt of two-stage revision.

**Treatment regimen:**

The protocol definitions of the interventions are provided in the DSA for the Antibiotic duration domain (extended prophylaxis) following a two-stage revision (see DSA AB Duration part B, section 6.3).

Entry into the domain for randomised treatment is determined based on the adoption of two-stage revision and survival through the second stage of surgery.
Determination of two-stage revision is made following the first stage operation (see DSA AB Duration part B, section 6.2.1) and the reveal to extended prophylaxis randomised treatment is made following the second stage operation. This has obvious implications on the necessity to survive through the intervening period.
In other words, if a patient is intended to have a two-stage revision, but does not survive to and through the second procedure, then they are not revealed to their extended prophylaxis assignment and do not contribute to the randomised comparison.

While receipt of two-stage revision precludes entry into the backbone antibiotic domain, patients in this domain also receive an antibiotic choice domain assignment (or non-randomised care).

**Intercurrent events:**

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-e1 where the treatment policy ICE strategy aims to establish the effect of treatment assignment.

```{r}
#| echo: FALSE
#| label: tbl-ice-e1
#| tbl-pos: H
#| tbl-cap: "Extended prophylaxis domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "E.1(i1)" , "None"  , "If the patient has slow improvement, recrudescence of infection or need to return to theatre then clinicians may choose to prolong extended prophylaxis therapy. Expected in x% of patients." , "Extension to therapy" , "Treatment policy" ,
"E.1(i2)" , "None"  , "If the patient shows late positive culture, they may become ineligible post-reveal and would likely require an additional 6-12 weeks of backbone antibiotic. Expected in x% of patients." , "Extension to therapy" , "Treatment policy" ,
"E.1(i3)" , "12 wk"  , "Adverse effects of antibiotics or patient discharge/relocation may lead to early termination of therapy. Expected in x% of patients." , "Discontinuation" , "Treatment policy" 
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Treatment",
    ice = "ICE",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "65%")  |> 
  tab_footnote(
    footnote = md("Extended therapy in the no extended prophylaxis group would make the group more similar to the 12 week group leading to increase likelihood of non-inferiority decision, i.e. conclusions may anti-conservative."),
    locations = cells_body(
      columns = class,
      rows = 1
    )
  )  |> 
  tab_footnote(
    footnote = md("Discontinuation in the 12 week group would make the responses more similar to the no extended prophylaxis group."),
    locations = cells_body(
      columns = class,
      rows = 3
    )
  )

gt_tbl
```

The treatment regimen under evaluation is thus the randomised and revealed extended prophylaxis treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.

**Summary measure:**

The population-level summary is an absolute risk difference with respect to treatment success comparing 12 weeks extended prophylaxis and none in patients receiving two-stage revision in conjunction with the treatments in other domains as determined by the design dependencies and usual care.

**Main estimator:**

The population-level summary is obtained via g-computation, which provides a counterfactual comparison across the relevant cohort, here restricted to patients in receipt of two-stage revision under a landmark analysis. 
We estimate the unit-level probability of treatment success under each randomised intervention in the extended prophylaxis domain and average over the sample
A Bayesian bootstrap procedure to account for uncertainty in the covariate distribution.

**Data useful for estimand:**

Per the considerations and definitions for B.1.

**Missing data:**

Per the considerations and definitions for B.1.

**Sensitivity:**

Per the considerations and definitions for B.1.


#### Estimand C.1 (antibiotic choice intervention)

**High-level overview:**

The estimand considers the effect of the antibiotic choice on treatment success at 12 months, specifically whether the use of rifampicin is more effective than no rifampicin following the initial surgical procedure (irrespective of type) and 

*...where treatment in other domains are given according to the trial design dependencies and usual practice specific to the surgical procedure received.*

**Treatment regimen:**

The protocol definitions of the interventions are provided in the DSA for the Antibiotic choice domain (see DSA AB Choice, section 7.3).

Entry into the domain for randomised treatment is again predicated on survival through the initial surgical procedure, i.e. after a DAIR, one-stage or between the first and second stage of a two-stage revision.

Given that the reveal process for antibiotic choice will occur after the revision type (one or two-stage) has been nominated by the surgeon, it cannot influence the surgeon's decision. 

**Intercurrent events:**

Potential intercurrent events and the approaches used to handle them are summarised in @tbl-ice-c1 where the treatment policy ICE strategy aims to establish the effect of initially randomised treatment.

```{r}
#| echo: FALSE
#| label: tbl-ice-c1
#| tbl-pos: H
#| tbl-cap: "Choice domain intercurrent events"

d_tbl <- tribble(
  ~ id, ~ arm, ~ ice, ~ class , ~ strategy, 
  "C.1(i1)" , "None"  , "If the patient has slow improvement (e.g. 1-4 weeks post operatively), clinicians may add rifampicin despite assignment. Expected in x% of patients." , "Switchover" , "Treatment policy" ,
"C.1(i2)" , "Rifampicin"  , "If the site pharmacy runs out of or does not have any rifampicin in stock, this may lead to early termination or non-receipt of therapy. Expected in x% of patients." , "Discontinuation or non-receipt" , "Treatment policy" ,
"C.1(i3)" , "Rifampicin"  , "Adverse effects of rifampicin (intractable nausea, severe hepatitis) may lead to early termination of therapy. Expected in x% of patients." , "Discontinuation" , "Treatment policy"  
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    id ~ pct(10),
    arm ~ pct(10),
    ice ~ pct(50),
    class ~pct(15),
    strategy ~pct(15)
  ) |>
  cols_label(
    id = "ID",
    arm = "Treatment",
    ice = "ICE",
    class = "Class",
    strategy = "Strategy"
  ) |>
  tab_options(table.font.size = "65%") |> 
  tab_footnote(
    footnote = md("Both discontinuation/non-receipt of rifampicin or addition of rifampicin to the the control group make groups more similar than they otherwise would be."),
    locations = cells_body(
      columns = class,
      rows = c(2,3)
    )
  )

gt_tbl
```


The treatment regimen under evaluation is thus the randomised and revealed antibiotic choice treatment in conjunction with any occurrence of specified or unspecified ICE(s) in combination with randomised and non-randomised treatments associated with other domains.
That is, interest is in the comparison of groups without allowances for lack of adherence, adding or switching, changes in background medication, and so on.

**Summary measure:**

The population-level summary is an absolute risk difference with respect to treatment success comparing rifampicin and no rifampicin following the initial procedure in conjunction with the treatments in other domains as determined by the design dependencies and usual care.

**Main estimator:**

The population-level summary is obtained via g-computation, which provides a counterfactual comparison across the relevant cohort under a landmark analysis.
We estimate the unit-level probability of treatment success under each randomised intervention for the antibiotic choice domain and average over the sample. 
A Bayesian bootstrap procedure to account for uncertainty in the covariate distribution.

**Data useful for estimand:**

Per the considerations and definitions for B.1.

**Missing data:**

Per the considerations and definitions for B.1.

**Sensitivity:**

Per the considerations and definitions for B.1.



## Study design

ROADMAP is an investigator-initiated, phase IV, open label, multicentre, pragmatic, randomised embedded multifactorial adaptive platform (REMAP) formulated to investigate the effectiveness of multiple study interventions simultaneously in cohorts of patients with confirmed or likely prosthetic joint infection in a large joint (hip, knee) with no age restriction.
ROADMAP also includes the development of a registry, although that will not be discussed here.

Initial treatment modality groups (domains) examine surgery type, antibiotic duration, extended prophylaxis and antibiotic choice.
New interventions are permitted to enter into existing domains and new domains are also permitted, both subject to steering committee and ethics review.

ROADMAP will be conducted sequentially (as cohorts of 500 patients reach their primary endpoint).
Decision rules evaluated on parameter estimates of interest, which drive domain-level stopping rules and platform conclusions.
Early stopping is permitted under pre-specified conditions, specifically for superiority, non-inferiority and futility as applicable to the given domain.

Bayesian methods were selected for their flexibility, ease of uncertainty quantification and their capacity for incorparating adaptive elements, as well as regularisation of parameter estimates and relatively straight forward interpretation.

### Randomisation

Units will be unconditionally randomised (under fixed complete randomisation, i.e. non-adaptive and without restriction through blocking or stratification or other constraints) to one arm within every domain [@Rosenberger2016].
The method was selected for its operational simplicity.

Domain specific assignments are revealed based on the design dependencies.
For example, only units in receipt of one-stage revision are revealed to randomised assignment for antibiotic duration and this also precludes entry into extended prophylaxis.
Similarly, only units in receipt of two-stage revision can be revealed to randomised assignment for extended prophylaxis. 
The reveal process actuates the randomised treatment and, it is not until this occurs, that the unit will contribute to the inference for the randomised comparison.

As the study progresses, decisions may occur at a domain level that prevent subsequent reveal for applicable treatment arms.
However, patients that have entered the platform but have not been revealed at the time of a stopping decision will, in general^[Are there exceptions where this would not be the case?], retain their original assignment.

### Sample size

While the study is intended to be perpetual, the initial trial funding and infrastructure has sufficient resources to enrol up to 2,500 participants into the platform.
The sample size is therefore constrained by the available resources and the desired trial structure.
The actual sample size may be lower than 2,500 if stopping rules are invoked.
Further details of the expected sample size under various scenarios can be found in the simulation report.

### Data management

An overview of data management procedures is provided in the Master Protocol (section 8.12) with some further detail in the Registry appendix (section 7.6).

The data storage approach will be decomposed into redcap components and (out-sourced proprietary) platform components developed by Spiral Software^[https://spiral.co.nz/] with source data (obtained from various medical records or direct report) entered by site personnel.
Spiral are also responsible for the implementation of the randomisation processes.

# Statistical methods

## Analysis sets

### Intention to treat (full analysis set)

The intent to treat (ITT) principle address what participants and what data to include on each person entering the study.
A strict interpretation of ITT demands collection and analysis of all randomised units, but in practice minor deviations from this are routinely accepted.

Estimands B.1 through C.1 align with the ITT perspective through their use of the treatment policy strategy.
The analysis population used for these estimands will be referred to as the full analysis set and comprise all units that were randomised and revealed to at least one of the domain interventions and have passed the primary endpoint of 12-months.
Per the treatment policy strategy, all randomised patients will be included and analysed according to the regimen to which they were initially allocated irrespective of any deviations from this regimen or any other protocol deviations.

Participants that have reached follow up, but for whom information has not yet been gathered will be treated as missing and excluded from analyses until the data has been entered.

### Per-protocol

For supportive estimands, we define a per-protocol analysis comprising participants that completed protocolised progression through the study without deviation.
That is, both participant and clinical team adheres with the predefined procedures, criteria and/or timelines detailed in the protocol that span consent, eligibility, adherence to randomised (and non-randomised) interventions, data collection and safety.
The minimal requirements for determining that patients met protocolised treatment criteria (i.e. the accepted delivery of intervention) are provided in @tbl-pp1.
Further detail is available in the relevant DSAs.

Clinical research staff will review patient records in order to identify the per-protocol population.
Ideally, the review procedures will be pre-specified and undertaken by an independent subject matter expert.

```{r}
#| echo: FALSE
#| label: tbl-pp1
#| tbl-pos: H
#| tbl-cap: "Minimal requirements for per protocol population"

d_tbl <- tribble(
  ~ domain, ~ assignment, ~ per_protocol_reqt, 
  "Surgical", "DAIR", "Part or all of the index prosthesis was retained, and an open arthrotomy was performed, including synovectomy, lavage and exchange of modular components (if present), between platform entry and day 90",
  "", "Revision", "The index prosthesis was completely removed, with no residual prosthetic components, and either a new prosthesis or a temporary spacer was placed at the first stage operation, between platform entry and day 90",
  "Antibiotic duration", "6 weeks", "At least 5 weeks but no more than 7 weeks of antibiotic therapy has been completed between the date of the one-stage revision and 16 weeks later",
  "", "12 weeks", "At least 11 weeks and no more than 13 weeks of antibiotic therapy has been completed between the date of the one-stage revision and 16 weeks later",
  
  "Extended prophylaxis", "None", "Less than 14 days of antibiotics were received for the index joint between the reimplantation operation and platform day 90",
  
  "", "12 weeks", "10-14 weeks of antibiotics were received for the index joint between the reimplantation operation and platform day 90",
  
  "Antibiotic choice", "Rifampicin", "At least 1 dose of rifampicin was received on each of at least 7 days between confirmation of domain eligibility and the end of platform day 28.",
  "", "None", "Less than 3 doses of rifampicin were received (i.e. zero, one or two) between confirmation of domain eligibility and the end of platform day 90.",
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(20),
    assignment ~ pct(20),
    per_protocol_reqt ~ pct(60)
  ) |>
  cols_label(
    domain = "Domain",
    assignment = "Assignment",
    per_protocol_reqt = "Requirement"
  ) |> 
   tab_footnote(
    footnote = md("Antibiotics [if the patient is still on them] are ceased within 24 hours of confirmation of allocation reveal – which will be 4-10 days post the reimplantation stage"),
    locations = cells_body(
      columns = domain,
      rows = 5
    )
  ) |>
  tab_options(table.font.size = "65%")

gt_tbl
```

## Subgroups {#sec-subgroups}

Stratification of data to subgroup populations enable the exploration of effect heterogeneity, but come at the increased risk of instability, bias and false positives.

The subgroup populations have been identified in the DSAs (DSA Surgical Late-acute section 9.6, DSA for AB duration part A section 9.6, DSA AB Duration part B section 8.6, DSA AB Choice section 9.6) but descriptions are presented here in abbreviated form for convenience, see @tbl-subgrp-1.
The analysis approach for subgroups is detailed in @sec-subgroup-analyses.

```{r}
#| echo: FALSE
#| label: tbl-subgrp-1
#| tbl-pos: H
#| tbl-cap: "Subgroup populations"

d_tbl <- tribble(
  ~ domain, ~ subgroup, 
  "Surgical", "Site of infection by joint (hip/knee) in the index prosthesis (the infected prosthesis that was present at time of platform entry and for which the patient met eligibility criteria)",
  "", "Duration of symptoms at domain entry (categorised as duration <= 7 days, 7 days < duration <= 14 days,  14 days < duration <= 21 days)", 
  "", "At least one causative organism is known at the time of domain eligibility assessment to be Staphylococcus aureus versus not", 
  "", "Serum C-reactive protein (CRP) at platform entry <100 versus >=100", 
  "", "Time from implantation of the index prosthesis to domain entry in days", 
  "", "One stage versus two stage revision (in those who are allocated to revision surgery)", 
  
  "Antibiotic duration", "Silo membership (early, late-acute or chronic)",
  "", "At least one causative organism is known at the time of domain eligibility assessment to be Staphylococcus aureus versus not",
  "", "Revision procedure has all elements of an ‘ideal’ procedure vs.  not",
  
  "Extended prophylaxis", "Silo membership", 
  "", "At least one causative organism is known at the time of domain eligibility assessment to be Staphylococcus aureus versus none", 
  "", "Categorised duration between first-stage and reimplantation procedure", 
  "", "Categorised duration of antibiotic treatment between first-stage and reimplantation procedure", 
  
  "Antibiotic choice", "Type of surgery (DAIR, one-stage, two-stage)", 
  "", "At least one causative organism is a Staphylococcus (any species) versus none"
  )


gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    domain ~ pct(30),
    subgroup ~ pct(70)
  ) |>
  cols_label(
    domain = "Domain",
    subgroup = "Subgroup"
  ) |>
  tab_footnote(footnote = "For the surgical domain, one versus two stage revision effects are already addressed within the primary analysis model.") |>
  tab_options(table.font.size = "65%")

gt_tbl
```



## Descriptive summaries

A CONSORT diagram will will be provided aiming to detail patient progression including:

+ participants screened
+ participants eligible by domain (giving reasons for ineligibility)
+ participants consented (a single consent process covers the platform and all relevant domains, see Core protocol, section 8.4)
+ participants entering into randomised treatment (revealed) by domain and intervention
+ participants withdrawing from study
+ participants reaching 12-month follow up

Recruitment numbers will be reported by region, site, silo.
Detail on intervention availability by domain will be presented by site.
Number of protocol deviations and intercurrent events will be summarised by domain and intervention.

Baseline characteristics will be provided by silo, domain and intervention including:

+ age
+ sex
+ ethnicity
+ number of comorbidities
+ ?

Concomitant medications will be reported, if available.

## Sequential analyses

Interim analyses will be run over the life of the trial to evaluate pre-specified decision criteria.
Analyses will start once 500 participants have reached 12 months follow up and every subsequent 500 participants thereafter.
Prior to each analysis, a SAP release will be created within the github repository and the release will be referenced within the analysis report.

With the exception of the clinicial team involved in administration of the treatments and patients, only the analytical and data groups, that are responsible for providing analysis results to the DSMC, will have access to individual-level treatment group assignments.

The interim analysis will focus solely on the primary outcome and will follow the approach detailed in @sec-primary-analysis.
In the event of a futility trigger being met, a subgroup analysis will be run which will enable the DSMC to explore the decision of whether heterogeneity in any subgroups is sufficient to warrant continuing the study for particular groups.

Subgroup analyses may be run at each interim analysis if futility rules have being triggered, see @sec-subgroup-analyses.

## Analysis approach

Analyses will be conducted within a Bayesian framework with a focus on the estimation of estimands, see @sec-estimands.
Parameter estimates will be computed via Markov chain Monte Carlo (MCMC) using Hamiltonian Monte Carlo (HMC).
Posterior summaries will be reported as posterior means and medians, with 95% credible intervals and posterior standard deviations.
Convergence will be assessed visually and with reference to appropriate statistics. 
Model fit will be considered with reference to posterior predictive checks.

## Primary analysis {#sec-primary-analysis}

The primary analysis model for ROADMAP adopts an at-the-margins analysis, that is making the assumption of no interactions across domains (e.g. the effect of revision relative to DAIR in the surgical domain is the same irrespective of whether the participant is allocated to no-rifampacin or rifampacin in the AB choice domain), see @kahan2022.
The model will adjust for silo, joint, preference for revision type, treatment regimen, time period of recruitment, region/site and baseline characteristics.
As some parameters are undefined for some intervention options, the model can be specified as follows:

<!-- see the latex physics manual for vector va, vb notation -->
<!-- in brief, for greek letters you need the * -->

$$
\begin{aligned}
Y &\sim \text{Bernoulli}(\pi) \\
\text{logit}(\pi)  &=  \alpha + \lambda_{s} + \rho_{j} + \delta + \tau_t + \psi_r + \zeta_{z(r)} + \xi \\
\delta &= \begin{cases}
  \beta_{1[d1, s]} + \beta_{4[d4]} + \phi_{p}   & \text{(dair)} \\
  \beta_{1[d1, s]} + \beta_{2[d2]} + \beta_{4[d4]}  & \text{(one-stage)} \\
  \beta_{1[d1, s]} + \beta_{3[d3]} + \beta_{4[d4]} + \phi_{p} & \text{(two-stage)} 
\end{cases} \\
\end{aligned}
$$

<!-- alternatively for transpose use \va{x}_{d}^\top -->

where $Y$ is a binary variable representing unit level treatment success with probability $\pi$ and the linear predictor terms are as follows:

+ $\alpha$ reference level log-odds of a successful outcome
+ $\lambda_s$ silo membership $s$
+	$\rho_j$ site of infection $j$
+	$\beta_{1[d_1,s]}$ surgical intervention $d_1$ in silo $s$
+	$\beta_{2[d_2]}$  backbone antibiotic duration intervention $d_2$
+	$\beta_{3[d_3]}$ extended prophylaxis duration intervention $d_3$
+	$\beta_{4[d_4]}$ antibiotic choice intervention $d_4$ 
+	$\phi_{p}$ surgeon preference for one/two stage, $p$, assuming unit randomised to revision
+	$\tau_t$ randomisation period $t$
+	$\psi_r$ region $r$ 
+	$\zeta_{z(r)}$ site $z$ nested within region $r$
+	$\xi$ linear combination of parameters accounting for baseline heterogeneity

Baseline characteristics include:

+ presence of immune compromise
+ presence of more than one comorbidity (diabetes, rheumatoid arthritis, obesity, chronic kidney disease)
+ smoking
+ age
+ frailty
+ ...

Continuous measures may be modelled via a penalised smoothing to accommodate non-linearity.

Parameters estimates will be reported as point and interval summaries of the posterior.
The treatment effect estimands will be calculated from the posterior using g-computation, see @sec-statistical-quantities.

### Priors

We will use weakly informative priors that aim to constrain the parameter estimates to within plausible ranges and are consistent with the belief that extreme treatment effects are unlikely.
Priors remain the same throughout the study.
The prior for reference log-odds, $\alpha$, will be set to

$$
\alpha \sim \text{Logistic}(0.7, 0.7) \quad \text{location/scale}
$$

Converted to the probability scale, this gives a prior median approximately equal to 0.65 and has a 90% HDI between 0.3 and 0.99.

The priors for all main effects will be set to $\text{Normal}(0, 1)$.

Noting that some domains may vary their active set of interventions over time, a first-order random walk may be incorproated into the model to account for temporal variation in the background response.
The random walk prior has the following structure

$$
\begin{aligned}
\tau_1 &= 0 \\
\tau_i &= \text{Normal}(\tau_{i-1}, \sigma_\tau) \quad \forall \ i > 1 \\
\sigma_\tau &\sim \text{Exponential}(1)
\end{aligned}
$$

with indexes aligned with analyses and the $\tau_1$ term representing the current quarter (i.e. 3 monthly intervals).
The time adjustment will only be included in the model if treatment options are varied over time.

The prior for region will be set as per the main effects detailed above with the first region fixed to zero. 
Site priors will be nested within region and set as 

$$
\begin{aligned}
\zeta_{z(r)} &\sim \text{Normal}(0, \sigma_\zeta) \\
\sigma_\zeta &\sim \text{Exponential}(1)
\end{aligned}
$$

The primary model results will be assessed using posterior predictive checks. 
If issues with the pre-specified models arise, the necessary modifications will be reported along with any necessary justification of the rationale for the variation.

## Sensitivity analysis (applicable to primary)

Sensitivity analyses of the results to the pre-specified priors will be run at each analysis and variations to the pre-specified models may be explored.

These analyses may include exploration of whether treatment interactions are apparent across domains.
For example, analyses may consider the interaction of the surgical by AB choice domains.
While these results may be reported, no formal prespecifications of what constitutes evidence of  interaction effects are given.

Additional models (either simpler or more complex) may be investigated as part of checks of sensitivity, stability, and model fit.


## Subgroup analyses {#sec-subgroup-analyses}

Pre-specified subgroup analyses will be restricted to the primary model with additional post-hoc exploratory subgroup analyses being discretionary.
The general approach will be to use the complete data, incorporating first-order interactions via hierarchical modelling for each subgroup considered.
All subgroups will be discretized into 3 categories or less.

Analyses will be run at the time of final reporting for each domain, but also at interim analyses for the relevant domain-level subgroups, if a futility decision is triggered.
The latter analysis motivated by a prior belief of clinically relevant treatment effect heterogeneity and a desire to mitigate the possibility of terminating entry into a domain for subgroups when the possibility of a positive outcome remained.

To account for subgroups a main effect for each subgroup is introduced into the model as is first order interaction to account for subgroup by treatment heterogenity.
The latter component is modelled as a hierarchical term with a shared domain level variance. 

As a simple example, assume a two-domain setup with two distinct subgroups per domain, ignoring other terms for simplicity.
The assumed model would take the following form:

$$
\begin{aligned}
Y &\sim \text{Bernoulli}(\pi) \\
\text{logit}(\pi)  &=  \alpha + \beta_A + \beta_{a_1} + \gamma_{[A,a_1]} + \beta_{a_2} + \gamma_{[A,a_2]} + \beta_B + \beta_{b_1} + \gamma_{[B,b_1]} + \beta_{b_2} + \gamma_{[B,b_2]}  \\
\\
(\beta_A,\beta_B) &\sim \text{Normal}(0,1) \\
(\beta_{a_1},\beta_{a_2},\beta_{b_1},\beta_{b_2}) &\sim \text{Normal}(0,1) \\
(\gamma_{[A,a_1]}, \gamma_{[A,a_2]}) &\sim \text{Normal}(0,\sigma_{\gamma_A}) \\
(\gamma_{[B,a_1]}, \gamma_{[B,a_2]}) &\sim \text{Normal}(0,\sigma_{\gamma_B}) \\
\sigma_{\gamma_A} &\sim \text{Exponential}(1) \\
\sigma_{\gamma_B} &\sim \text{Exponential}(1)
\end{aligned}
$$

where $\beta_A$, $\beta_B$ represent domain level treatment effects, $\beta_{a_1}$, $\beta_{a_2}$, $\beta_{b_1}$, $\beta_{b_2}$ represent main effects for subgroups for domains A and B respectively and $\gamma_{[A,a_1]}$, $\gamma_{[A,a_2]}$, $\gamma_{[B,B_1]}$, $\gamma_{[B,b_2]}$ represent the first order interaction terms.
For the case where heterogeneity for the same subgroup is explored across domains, a single main effect will be included along with the first order interactions with each relevant domain level treatment.


<!-- minutes from 2024-09-09 -->

<!-- a.	Subgroups on joint: MJ: decision was to not look at heterogeneity in joint and make all decisions like assuming constant effects across joint in the interim analyses. At the interim analyses, do the subgroup analysis to look at heterogeneity by joint, and then have some sort of policy to put forward a case to the DSMC if needed as a way to see the differences in effects for various groups. LM: piano data doesn’t suggest there is a major difference in surgical outcomes between the two groups. Updated core protocol provides us the opportunity to leave one group open is there is inconsistency across the subgroups. MJ: operational perspective: make futility decision on surgery, look at sub-group specific effects of surgery and if one isn’t futile, there is the opportunity to continue randomising for those sub-groups. For any sub-groups in any of the domains (to avoid doing additional ethics amendment). Subgroups analysis only if the trigger is met.  MJ to consider -->

## Supportive (domain agnostic) analyses

The following sections detail analyses applying to all domains and interest is in treatment effects over all domains.

Unless otherwise stated:

+ the models will be fit using the full analysis set
+ the model linear predictor and priors will be equivalent to those used in the primary analysis
+ ICEs will be handled via the treatment policy strategy

### Treatment success at 12 months

Treatment success at 12 months will be analysed based on the same composite outcome variable for the primary analysis but using the per protocol analysis set where per protocol is define with reference to all domains simultaneously.

### Desirability of outcome ranking

A desirability of outcome ranking (DOOR) analysis involves unit level comparisons between all trial participants across the treatment arms.
Each patient receives a single rank to characterise their overall state at 12-months after platform entry with the current DOOR criteria provided in @tbl-sec-door.

```{r}
#| echo: FALSE
#| label: tbl-sec-door
#| tbl-pos: H
#| tbl-cap: "Ranking criteria for desirability of outcome for PJI"

d_tbl <- tribble(
  ~ Rank, ~ Alive, ~ JointFunc, ~ TrtSuccss , ~ Qol, 
  "1", "Yes", "Good", 
    "Yes", "Tiebreaker based on EQ5D5L",
  "2", "Yes", "Good", "No", "Tiebreaker based on EQ5D5L",
  "3", "Yes", "Poor", "Yes", "Tiebreaker based on EQ5D5L",
  "4", "Yes", "Poor", "No", "Tiebreaker based on EQ5D5L",
  "5", "No", "-", "-", "-"
  )

gt_tbl <- gt(d_tbl) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  cols_width(
    Rank ~ pct(10),
    Alive ~ pct(10),
    JointFunc ~ pct(15),
    TrtSuccss ~ pct(15),
    Qol ~ pct(40)
  ) |>
  cols_label(
    Rank = "Rank",
    Alive = "Alive",
    JointFunc = "Joint Function",
    TrtSuccss = "Treatment Success",
    Qol = "Qol"
  ) |> 
   tab_footnote(
    footnote = md("*'Good'* joint function is based on thresholds related to patient reported success. A successful outcome at 12-months will be defined for knee PJI with an Oxford Knee Score (OKS) at 12 months of >36 or an improvement (delta) from baseline of >9 and for hip PJI as a Oxford Hip Score (OHS) of >38 or an improvement of >12 (35)."),
    locations = cells_body(
      columns = JointFunc,
      rows = 1
    ) 
    ) |> 
   tab_footnote(
    footnote = md("Treatment Success relates to primary outcome definition."),
    locations = cells_column_labels(columns = TrtSuccss) 
  ) |>
  tab_options(table.font.size = "65%")

gt_tbl
  
```

The DOOR analysis approach targets a *DOOR probability*, more broadly referred to as a Probabilistic Index (PI), see @DeSchryver2018 and is closely related to the Mann-Whitney-U statistic.
The PI refers to the probability that the outcome of a randomly selected subject in one group exceeds the outcome of another randomly selected subject in another group (plus half of the probability of a tied DOOR), see @Evans2015.
In principle, it targets:

$$
\begin{aligned}
\text{Pr}(Y_e > Y_c)
\end{aligned}
$$

where $Y_e$ is a random variable describing the outcome under an experimental treatment and $Y_c$ is a corresponding outcome under the control.

To calculate the PI we will enumerate all pairwise comparisons between all patients (win, loss, tie) and then the PI is given by

$$
\begin{aligned}
PI &= \frac{ (n_{\text{win}} + 0.5 n_{\text{tie}}) } { n_\text{trt} n_\text{ref} } 
\end{aligned}
$$

where $n_{\text{win}}$ and $n_{\text{tie}}$ denote the number of instances where the experimental units do *better* than the control patients or have equivalent ranking respectively for all pairs and $n_\text{trt}$ and $n_\text{ref}$ denote the number of patients in each of the two arms being compared.
Confidence intervals will be derived via a bootstrap procedure.

Separate DOOR analyses will be run on strata based on the assessment and ranking of the relevant outcomes at 12-months.
That is, in the DOOR analysis, we will compare a subset of units over the interventions specific to a given domain.
Specifically:

+ For the surgical domain, the PI will be computed for only the units within the late-acute silo revealed to randomised treatment for this domain (and restricted to those that entered non-randomised treatment in the duration and extended prophylaxis domain in order to avoid inducing bias in the surgical domain)
+ For the antibiotic duration domain, the PI will be computed for only the units that received one-stage revision and revealed to randomised treatment for this domain
+ For the extended prophylaxis domain, the PI will be computed for only the units that received two-stage revision and revealed to randomised treatment for this domain
+ For the antibiotic choice domain, the PI will be computed for all units revealed to randomised treatment for this domain

### Patient-reported joint function

The Oxford Hip Score (OHS) is a joint-specific, patient-reported outcome measure that has been designed to assess disability in patients undergoing joint replacement. 
The score is computed based on the responses to a 12-item survey.
Under the 2007 specification, responses range from 0 to 4 for each question and the total score has a maximum (best) value of 48 with 40-48 indicating satisfactory joint function and 3-5 being a suggested clinically important difference.

The OHS will be analysed using cumulative logistic regression based on the data obtained at 12-months after platform entry.
Letting $Y \in \{ 1, 2, \dots K \}$ denote the outcome (with $K = 49$ here, accounting for death as the lowest level) for unit $i$, the proportional odds model can be considered with reference to categorising some latent continuous variable $Y^*$.
Ordered cut-points, $c \in \mathbb{R}^{K-1}$ are defined such that $c_k < c_{k+1}$ with

$$
\begin{aligned}
\text{logit}(\text{Pr}(Y \le c)) = c_k - x^\top \beta
\end{aligned}
$$

<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \pi_{ik} = \text{Pr}(Y_i = k | \eta_i, c) = \begin{cases} -->
<!--     1 - \text{logit}^{-1}(\eta_i - c_1), & k=1\\ -->
<!--     \text{logit}^{-1}(\eta_i - c_{k-1}) - \text{logit}^{-1}(\eta_i - c_k), & 1 < k < K \\ -->
<!--     \text{logit}^{-1}(\eta_i - nc_{K-1}) , & k = K  -->
<!-- 		 \end{cases} -->
<!-- \end{aligned} -->
<!-- $$ -->

and where the linear predictor (generically stated in the above) would have terms and priors analogous to those used in the primary analysis.
The priors for the intercept terms would be based on a weakly informative Dirichlet distribution.
If scores are sparse, then aggregation may be adopted.

### Patient-reported quality of life (EQ5D5L)

The the EuroQOL 5 dimension 5 levels (EQ-5D-5L) instrument is a preference-based QoL instrument comprised of five dimensions: mobility, self-care, usual activities, pain/discomfort, and anxiety/depression.
Respondents are asked to choose the most appropriate option from five alternatives (none, slight, moderate, severe, or extreme problems). 
In addition, respondents are asked to indicate their present health state on a visual analogue scale (EQ VAS) ranging from the worst imaginable health state (“0”) to the best imaginable health state (“100”).

At this time, we assume that the QoL at 12-months after platform entry will be analysed by the health economics team and is therefore not specified here.

### Cost effectiveness

Similar to QoL at 12-months after platform entry we assume that this outcome will be analysed by the health economics team and is therefore not specified here.

### All-cause mortality to 12 months {#sec-all-cause-mortality}

We will use a logistic regression model to analyse all-cause mortality to 12-months after platform entry.
Specifically, if $Y$ is a binary indicatoring with $Y = 1$ indicating death from any cause at 12-months, we model:

$$
\begin{aligned}
Y &\sim \text{Bernoulli}(p) \\
\text{logit}(p) &= \eta = x^\top \beta
\end{aligned}
$$

where $\eta$ takes the same form as the primary analysis, see @sec-primary-analysis.

### Clinical cure to 12 months {#sec-clinical-cure}

The occurrence of clinical cure, defined in the master protocol as no clinical or microbiological evidence of infection, is subject to the competing risks of death and replacement of the initial prosthesis.
We will use a logistic regression model to analyse clinical cure to 12-months after platform entry following an analogous approach to @sec-all-cause-mortality.

Given the possibilities of death and surgical removal of the initial prosthesis, this analysis actually yields a comparison of clinical cure (as defined within the context of the primary outcome) versus *either* clinical failure or death or replaced prosthesis.
This approach preserves the randomisation, whereas a conditional approach based on the set of participants that did not die and did had their initial joint replacement removed could induce selection bias.

### No longer taking any antibiotics for the index joint to 12 months {#sec-prop-ab-free}

Logistic regression will be used to analyse antibiotic use to 12-months after platform entry following an analogous approach to @sec-clinical-cure.

### Destination prosthesis still in place to 12 months {#sec-joint-in-place}

Logistic regression will be used to analyse the destination prosthesis status to 12-months after platform entry following an analogous approach to @sec-clinical-cure.

### Microbiological relapse b/w 100 days and 12 months {#sec-microbiological-relapse}

Logistic regression will be used to analyse the microbiological relapse status between 100 days and 12-months after platform entry following an analogous approach to @sec-clinical-cure.

### Microbiological reinfection b/w 100 days and 12 months

Logistic regression will be used to analyse the microbiological reinfection status between 100 days and 12-months after platform entry following an analogous approach to @sec-clinical-cure.

### Time alive and free from revision procedure to 24 months {#sec-time-alive-24}

We will use a proportional-hazards model to analyse time alive and free from revision^[For the purposes of this outcome, we include amputation in the definition of revision.] to 24-months after platform entry.
Specifically, assuming no time-varying covariates or coefficients:

$$
\begin{aligned}
h(t) = h_0(t) \exp(x^\top \beta)
\end{aligned}
$$

where $h_0(t)$ is the baseline hazard at time $t$ (weeks) and $x^\top \beta$ denotes the linear predictor.
The baseline hazard will be modelled as a smooth function of time using splines, i.e. the above is modified such that

$$
\begin{aligned}
h(t) = \sum_{l = 1}^L \gamma_l M_l(t; \vec{k}, \delta) \exp(x^\top \beta)
\end{aligned}
$$

where $M_l(t; \vec{k}, \delta)$ denotes the $l^{\text{th}}$ basis term for a degree $\delta$ M-spline function evaluated at knot locations $\vec{k}$ and $\gamma_l$ denoting the $l^{\text{th}}$ M-spline coefficient.

In the event of violation of proportional-hazards, appropriate model adjustments will be made as a sensitivity analysis.
Alternatively, other model formulations may be explored, such as an accelerated failure time models under a log-logistic or Weibull distributional assumptions.
Such models characterise effects in terms of survival times rather than hazards.

Treatment effects may be characterised in terms of differences in median time to event, hazard ratios, acceleration ratios, Restricted Mean Survival Time (RMST), as appropriate.
The RMST is defined as the area under the survival curve up to a specific time point and can be interpreted as the average time to event to 24-months.


{{< pagebreak >}}
## Supportive (domain specific) analyses

The following sections detail analyses that are domain-specific, i.e. where the interest is in treatment effects that are restricted to a given domain.

All these map to estimands are briefly outlined in the relevant DSAs.

Unless otherwise stated:

+ the models will be fit using the full analysis set
+ the model linear predictor and priors will be equivalent to those used in the primary analysis
+ ICEs will be handled via the treatment policy strategy




{{< pagebreak >}}
### Surgical domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the surgical domain.

#### Unplanned re-operation

Logistic regression will be used to analyse the occurrence of unplanned re-operation on the index joint more than 14 days after the initial definitive procedure to 12 months.

#### Dislocation of index joint

Logistic regression will be used to analyse the occurrence of dislocation of the index joint to 12 months.

#### Unplanned or unexpected periprosthetic fracture

Logistic regression will be used to analyse the occurrence of unplanned or unexpected periprosthetic fracture (either intraoperative or later on, requiring attendance at a hospital) to 12 months.




{{< pagebreak >}}
### Antibiotic duration domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the antibiotic duration domain.

#### Acute liver injury following platform entry to 90 days

Logistic regression will be used to analyse the occurrence of acute liver injury to 90 days post platform entry.

#### Acute kidney injury following platform entry to 90 days

Logistic regression will be used to analyse the occurrence of acute kidney injury to 90 days post platform entry.

#### Laboratory-proven *Clostridium difficile* diarrhoea to x days

Logistic regression will be used to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea to x days.

#### Antibiotics ceased due to suspected adverse reaction to 90 days

Logistic regression will be used to analyse the occurrence of ceasing at least one antibiotic due to other suspected adverse reaction between the time of domain entry to day 90.




{{< pagebreak >}}
### Extended prophylaxis domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the extended prophylaxis domain.

#### Time alive and free from any revision procedure to 12-months

Time alive and free from any revision procedure on the index joint captured by a national joint replacement registry within 12 months of domain entry will be analysed via a proportional hazards survival model, using an analogous approach to that detailed in @sec-time-alive-24.

#### Time alive and free from any revision procedure to 24-months

Time alive and free from any revision procedure on the index joint captured by a national joint replacement registry within 24 months of domain entry will be analysed via a cause-specific hazard survival model, using an analogous approach to that detailed in @sec-time-alive-24.

#### Laboratory-proven *Clostridium difficile* diarrhoea to 12-months

Logistic regression will be used to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea to 12-months.

#### Antibiotics ceased due to suspected adverse reaction to 12-months

Logistic regression will be used to analyse the occurrence of ceasing antibiotics due to *other* suspected adverse reaction between the time of domain entry to 12-months.




{{< pagebreak >}}
### Antibiotic choice domain

For the following, irrespective of the modelling approach, the effects of interest are only those relating to the antibiotic choice domain.

#### Acute liver injury to day 100

Logistic regression will be used to analyse the occurrence of acute liver injury to day 100 post platform entry.

#### Acute kidney injury to day 100

Logistic regression will be used to analyse the occurrence of acute kidney injury to day 100 post platform entry.

#### Laboratory-proven *Clostridium difficile* diarrhoea to 12-months

Logistic regression will be used to analyse the occurrence of laboratory-proven *Clostridium difficile* diarrhoea to 12-months.

#### Antibiotics ceased due to suspected adverse reaction to 100 days

Logistic regression will be used to analyse the occurrence of ceasing antibiotics due to *other* suspected adverse reaction between the time of domain entry to 100 days.

{{< pagebreak >}}
## Missing data

### Primary outcome variable

Given the use of a composite outcome variable for the primary analysis, missingness for the different composite elements could lead to different implications on the interpretation of the outcome.
The composite variable components (alive, no infection, no antibiotics, index prosthetic in place) are ascertained through the use of hospital databases, followup with healthcare provider and/or patient and/or data linkage with death registries.

Treatment failure is indicated if any of the four composite elements are observed to fail. 
That is, if we see any of death, absence of clinical cure, ongoing antibiotic use or destination prosthesis absent, then the unit is a failure and whether other elements of the composite are observed or missing is irrelevant.

Direct evidence of the patient being alive will be implied either by the absence of a death certificate or the existence of any of medical follow up that gives information on the other elements of the composite^[Although being alive is only up until the time of the surrogate observation, which may or may not be prior to the 12 month endpoint.].
If all other elements are missing and death cannot be confirmed by other sources then the unit could either be alive or dead (e.g. they might have died out of country although this seems highly improbable).
More likely is that if a patient cannot be found in a death registry, then they are alive (unless they moved overseas).

Clinical cure suggests that antibiotics would no longer be required and therefore could possibly be a proxy for antibiotic status if it were missing, although this would not be definitive.
Conversely, if the status of clinical cure were missing and antibiotic status were known, then we could possibly take the fact that antibiotics were not being received to imply clinical cure.

Destination prosthesis status could be not be implied by other elements of the composite and therefore the outcome status cannot be confirmed if it is missing.

### Covariates

When missing, some covariates can be completed by implication.
For example, if region is missing, but site is available, region is known with certainty.

### Handling missingness

When missingness is completely at random or dependent on covariates, but not jointly dependent on the exposure and the outcome nor dependent on an unobserved variable unrelated to the exposure, then, for logistic regression, the parameter estimate for the exposure is unbiased under complete case analysis [@hughes2019; @McElreath2020, pg 503].
As such, a complete case approach will be used at the interim analyses and final analysis as the headline inference.
However, a sensitivity analysis will be run for the final analysis using multiple imputation that imputates both the missing components of the composite primary outcome variable and missing covariate values.
Missing values will be imputed using a fully conditional specification via multivariate imputation by chained equations [@vanbuuren2011].

## Software

Analyses will be implemented in R and Bayesian models will be implemented in Stan and/or JAGS as required with posterior distributions approximated using Markov chain Monte Carlo.
Also software used will be disclosed in the reports.

# Quantities of interest {#sec-statistical-quantities}

## Treatment effects

The primary focus of inference is on estimating treatment effects for the randomised interventions.
As such, we consider comparisons amongst groups that are exchangeable (i.e. the potential outcome associated with any treatment is independent of the treatment that was assigned).
For the surgical domain, the choice of revision is left to the clinician and so, within revision type, we do not have exchangeability.
This is because what leads a surgeon to prefer one versus two-stage revision will likely be informative of outcome, making those that receive one-stage systematically different from those that receive two.

The following descriptions relate to the calculation of treatment effects for the primary analysis.
All domains adopt g-computation and a Bayesian bootstrap with that aims account for the uncertainty in the joint covariate distribution.

### Surgical domain {#sec-surgical-domain}

For the surgical domain, we calculate the effect of revision relative to debridement using g-computation and a Bayesian bootstrap as follows:

1. for each unit within the late acute silo, compute the posterior predicted probability of the outcome assuming they are assigned to DAIR and using the appropriate linear predictor (and transform) and where each of the remaining covariates are set at their natural values
2. for each unit within the late acute silo and preferenced to one-stage revision, compute the posterior predicted probability of the outcome assuming they are assigned to the revision group (and type determined from clinical preference) and using the appropriate linear predictor (and transform) with the antibiotic duration fixed at the non-randomised level and with each of the remaining covariates set at their natural values 
3. for each unit within the late acute silo and preferenced to two-stage revision, compute the predicted probability of the outcome assuming they are assigned to the revision group (and type determined from clinical preference) and using the appropriate linear predictor (and transform) with the extended prophylaxis fixed at the non-randomised level and with each of the remaining covariates set at their natural values 

4. for each set of predicted probabilities, form the scalar product with draws from a Dirichlet distribution of the relevant dimension to produce the average risk under DAIR, revision (one-stage), revision (two-stage) accounting for the uncertainty in the covariate distribution

5. form a weighted combination of the the revision (one-stage), revision (two-stage) estimates based on the distribution of preferences in the sample

6. derive the risk difference as the difference in the posterior probability of the outcome in the revision versus DAIR groups 


<!-- (Riemann-Stieltjes) -->

<!-- Specifically, we approximate the following integrals based on the fitted values for the patients in the late-acute silo: -->

<!--
$$
\begin{aligned}
\mathbb{E}[\hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l) d \hat{P}_L(l) \\
\mathbb{E}[\hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l) d\hat{P}_L(l) \\
\mathbb{E}[\hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l)] &= \int_{\mathcal{L}} \hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l) d\hat{P}_L(l) \\
\end{aligned}
$$


where $\hat{\eta}$ denotes the unit level log odds of the outcome, $d_k$ denotes the interventions in the surgical ($k=1$), duration ($k=2$) and extended prophylaxis domains ($k=3$) with the surgical domain ($d_1$) indexes corresponding to debridement, one-stage and two-stage respectively. 
Preference for surgical type under revision is denoted by $r$ and, finally, $l$ denotes the remaining covariate set including preference where it is not explicitly conditioned on and **other domain level interventions** not fixed for the purposes of the comparison, site, time effects etc.
We compute the effect of revision relative to debridement as:

$$
\begin{aligned}
\Delta_{d_1[1]} &= \mathbb{E}[\hat{\eta}(d_1 = 2, d_2 = 1, d_3 = 1, r = 1, l)]\mathbb{E}[r = 1] + \\ 
  & \quad \mathbb{E}[\hat{\eta}(d_1 = 3, d_2 = 1, d_3 = 1, r = 2, l)]\mathbb{E}[r = 2]  - \\ 
  & \quad \mathbb{E}[\hat{\eta}(d_1 = 1, d_2 = 1, d_3 = 1, l)]
\end{aligned}
$$

where $\Delta_{d_1[1]}$ denotes the log-odds-ratio comparison of interest^[There is currently only one comparison of interest for each domain but the index gives us the ability to refer to others should the need arise.], $\mathbb{E}[r = 1]$ and $\mathbb{E}[r = 2]$ are the relevant weights based on the observed distribution of preference for revision type in the sample.

-->


### Antibiotic duration domain 

The antibiotic duration domain treatment effects are estimated using methods analogous to those in @sec-surgical-domain, restricting to the subset revealed to randomised antibiotic duration, all of which would have received a one-stage revision and who would therefore have not entered into the extended prophylaxis domain.

### Extended prophylaxis domain 

The extended prophylaxis domain treatment effects are estimated using methods analogous to those in @sec-surgical-domain, restricted to the subset revealed to randomised extended prophylaxis, all of which would have received a two-stage revision and who would therefore have not entered into the antibiotic duration domain.

### Antibiotic choice domain

The antibiotic choice domain treatment effects are estimated using methods analogous to those in @sec-surgical-domain, restricted to the subset revealed to randomised antibiotic choice, with no restrictions on the entry into the other domains.
In the case of the antibiotic choice, the predicted posterior probability of the outcome is derived from the linear predictor applicable to the type of surgical intervention received.

### Subgroups

All subgroup effects are estimated using analogous methods to those above, but using an extended model as detailed in @sec-subgroup-analyses as the basis for prediction.
In brief, the predicted posterior probability of the outcome is calculated for each unit and each treatment arm across all subgroups.
Next, Dirichlet weights are drawn and used to compute the average subgroup specific risk, which in turn are used to calculate the treatment effects associated with the comparisons of interest.

# Decision procedures

## Overview

Trial decisions are made by calculating the probability that the posterior distributions for the treatment effects exceed or fall short of reference values and contrast this with a decision level, all nominated based on simulation studies and the clinical subject matter knowledge.
Simulation methods and results are provided in a separate report.

The trial considers:

+ superiority - indicating that an intervention is beneficial relative to a comparator
+ non-inferiority - indicating that an intervention is no worse than some clinically relevant threshold to a comparator 
+ futility - which indicates a low probability with respect to the relevant superiority or non-inferiority assessment (i.e. there are futility triggers for both superiority and futility for non-inferiority assessments)

The mathematical definitions of these quantities are provided below and a table of the thresholds currently in use is defined in @tbl-dec-thres.
Decision threshold and decision probabilities (the evidential requirements) remain fixed throughout the study at all analysis points.
Decisions are made with respect to the average value for any `random-effect' terms that might exist within the model.

```{r}
#| echo: FALSE
#| label: tbl-dec-thres
#| tbl-pos: H
#| tbl-cap: "Decision thresholds"


d_tbl <- tribble(
  ~ domain, ~ quantity, ~ threshold_probability, ~ decision_probability,
  "Surgical", "Superiority \n revision vs DAIR", "$>0$", "$\\ge 0.96$",
  "", "Futility \n revision vs DAIR", "$>0.05$", "$\\le 0.3$",
  "", "", "", "",
  
  "Antibiotic", "Non-inferiority \n 6 weeks vs 12 weeks", "$> -0.05$", "$\\ge 0.945$",
  "duration", "Futility \n 6 weeks vs 12 weeks", "$<0$", "$\\le 0.1$",
  "", "", "", "",
  
  "Extended", "Superiority \n 12 weeks vs none", "$>0$", "$\\ge 0.96$",
  "prophylaxis", "Futility \n 12 weeks vs none", "$>0.05$", "$\\le 0.3$",
  "", "", "", "",
  
  "Antibiotic", "Superiority \n rifampacin vs none", "$>0$", "$\\ge 0.99$",
  "choice", "Futility \n rifampacin vs none", "$>0.05$", "$\\le 0.3$"
  )


# see https://gt.rstudio.com/reference/fmt_markdown.html
gt_tbl <- gt(d_tbl, groupname_col = "Domain",
    row_group_as_column = TRUE) |>
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  fmt_markdown() |>
  cols_width(
    domain ~ pct(20),
    quantity ~ pct(40),
    threshold_probability ~ pct(15),
    decision_probability ~ pct(15)
  ) |>
  cols_label(
    domain = "Domain",
    quantity = "Quantity",
    threshold_probability = "Threshold\nprobability",
    decision_probability = "Decision\nprobability"
  ) |> 
  tab_options(table.font.size = "65%")

gt_tbl

```


The actions that follow after a decision threshold has been reached are detailed in the core protocol (section 9.7).

Any occurrence of a futility decision requires that a subgroup analysis be performed as per the populations listed in @sec-subgroups using the methods detailed in @sec-subgroup-analyses for the domain(s) for which futility is indicated.
For a futility decision to hold definitively, all subgroups within the relevant domain should show futility, consistent with the decision thresholds as detailed above.
Any subgroups that are not futile may be permitted to continue to enrol into the study. 
For example, if revision is shown to be futile relative to DAIR in the main comparison, but the subgroup analysis indicates that revision is not futile for those participants where the infection site is the hip (rather than knee), then randomised assignment in the surgical domain may continue for participants with hip infections.
Variations to this are permitted at the DSMC disgression.

## Superiority

Superiority implies that an intervention has high probability of being beneficial relative to a comparator intervention.
Superiority is a posterior probability assessment against a threshold value (for the current domain threshold values see @tbl-dec-thres) defined as:

$$
\begin{aligned}
\text{Pr}(\pi_{\text{trt}} - \pi_{\text{ref}} > \rho_{\text{sup}}) \ge \gamma_{\text{sup}}
\end{aligned}
$$

which resolves to a boolean indicator of treatment superiority based on the posterior estimate treatment comparison represented by an absolute difference between treatment and reference groups, $\pi_{\text{trt}} - \pi_{\text{ref}}$, relative to a reference value $\rho_{\text{sup}}$ at a probability greater than or equal to a threshold value  $\gamma_{\text{sup}}$.

## Non-inferiority

Non-inferiority implies that an intervention has a high probability of being no worse than some pre-specified threshold relative to the comparator intervention defined as

$$
\begin{aligned}
\text{Pr}(\pi_{\text{trt}} - \pi_{\text{ref}} > \rho_{\text{ni}}) \ge \gamma_{\text{ni}}
\end{aligned}
$$

which resolves to a boolean indicator of treatment non-inferiority based on the posterior estimate treatment comparison represented by an absolute difference between treatment and reference groups, $\pi_{\text{trt}} - \pi_{\text{ref}}$, relative to a reference value $\rho_{\text{ni}}$ at a probability greater than or equal to a threshold value  $\gamma_{\text{ni}}$.

## Futility

Futility in relation to either a superiority or a non-inferiority assessment implies that an intervention has low probability relative to the comparator intervention with respect to that assessment defined as 

$$
\begin{aligned}
\text{Pr}(\pi_{\text{trt}} - \pi_{\text{ref}} > \rho_{\text{fut}}) \le \gamma_{\text{fut}}
\end{aligned}
$$

which resolves to a boolean indicator of treatment futility based on the posterior estimate treatment comparison represented by an absolute difference between treatment and reference groups, $\pi_{\text{trt}} - \pi_{\text{ref}}$, relative to a reference value $\rho_{\text{fut}}$ at a probability greater than or equal to a threshold value  $\gamma_{\text{fut}}$ and where both $\rho_{\text{fut}}$ and $\gamma_{\text{fut}}$ can be specific to superiority and non-inferiority assessments.


# Adaptation

## Adaption considerations

Three possible adaptations are currently identified, namely early stopping (due to superiority, non-inferiority or futility), the addition of interventions within existing domains and the addition of entirely new domains.
The operational procedures associated with each of these adaptations are defined within the protocol.

<!-- The treatment regimen under evaluation is the randomised and revealed surgical treatment in combination with randomised and non-randomised treatments associated with other domains in the subset of patients that would adhere to all surgical domain interventions but that may have had specified or unspecified ICE(s) associated with other domains. -->


<!-- No problems Mark, -->
<!-- In the situation you mention, I would analyse the crossed over patient according to their original assignment because they had no choice but to cross over. So, in my mind, it is still a type of ‘hypothetical’ estimand, but one in which you only censor those who stopped or crossed over but who could have, in theory, stayed on their original assignment. The hypothetical estimand is the effect of the assignment (not the treatment) in which everyone who could have adhered, did adhere. Obviously the determination about whether they ‘needed to’ stop or cross-over may be subjective, which is a limitation. -->
<!-- Tom -->

<!-- From: Mark Jones <mark.jones1@sydney.edu.au>  -->
<!-- Sent: Wednesday, July 3, 2024 1:07 PM -->
<!-- To: Thomas Snelling <tom.snelling@sydney.edu.au> -->
<!-- Cc: Daniela Vargas <daniela.vargas@sydney.edu.au> -->
<!-- Subject: Re: roadmap - notes on itt/pp etc -->

<!-- Thanks for following up Tom, -->

<!-- I had to deal with the reviewers comments for stop yesterday and now am going through the manuscript for Michelle to try and get rid of that. Long story short is that it will probably be Friday or early next week before I have anything useful to go through. -->

<!-- I have thought about what you said for the view treatment effects (vs assignment effects) and wonder if a hypothetical estimand is the best option in that for someone with a loose joint assigned to dair since there is no option other than to cross over. Perhaps a principal stratum perspective might be more suitable in that instance. But I will have a look through the paper that you sent and have a think about it. My thought at the moment is that a mix of strategies is maybe necessary to address the different ices. There has been some work on using a mix, but I am not sure how broadly it is applied. -->

<!-- Regards -->
<!-- Mark -->


<!-- Mark Jones | Senior Biostatistician -->
<!-- Health and Clinical Analytics Lab, Sydney School of Public Health -->

<!-- THE UNIVERSITY OF SYDNEY -->
<!-- E mark.jones1@sydney.edu.au | W http://sydney.edu.au -->

<!-- Hi Mark. I have a meeting at 4-5pm today, but otherwise pretty flexible. Let me know if you’d like to schedule time to discuss this. -->
<!-- Tom -->

<!-- From: Thomas Snelling  -->
<!-- Sent: Monday, July 1, 2024 6:12 PM -->
<!-- To: Mark Jones <mark.jones1@sydney.edu.au> -->
<!-- Subject: RE: roadmap - notes on itt/pp etc -->

<!-- Actually, this paper might be more illustrative https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10505414/ -->
<!-- Tom -->

<!-- From: Thomas Snelling  -->
<!-- Sent: Monday, July 1, 2024 4:28 PM -->
<!-- To: Mark Jones <mark.jones1@sydney.edu.au> -->
<!-- Subject: RE: roadmap - notes on itt/pp etc -->

<!-- Thanks for this Mark. I’ve had a quick read through this. Useful to share this to prompt our collective thinking, but I expect we will need to be fairly directive with Josh about what we advise. -->
<!-- I think the appropriate estimand for the PP analysis is the hypothetical difference in effect that would be observed if everyone who could adhere to treatment actually did (and those couldn’t defaulted to something else) and where everyone who could in theory be followed up (i.e. because they weren’t dead and didn’t have an amputation), actually were. -->
<!-- In this case, we (only) censor those who stop adhering to their assigned treatment (but who could have reasonably adhered), and then effectively weight those who remain uncensored according to their inverse probability of censoring to minimise risk of confounding by factors that are both predictive of censoring and predictive of the outcome. Importantly, those who stopped or switched because they had no choice (eg loose or stuck joint), remain in their assigned strategy if though they stopped/ switched. -->
<!-- I’ve had a quick scan of the literature and found this paper. At a glance it looks like this aligns with what they advocate? Reducing Bias in Estimates of Per Protocol Treatment Effects: A Secondary Analysis of a Randomized Clinical Trial | Research, Methods, Statistics | JAMA Network Open | JAMA Network -->
<!-- https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2807637 -->

<!-- Regards, -->
<!-- Tom -->

<!-- The hypothetical strategy for handling ICEs is not appropriate here as  -->



# References

<!-- Needs to have a citation for this to work otherwise you will get the old \end{CSLReferences} error  -->

